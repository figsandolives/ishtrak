<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استمارات الاشتراكات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        
        /* إخفاء جميع النوافذ بشكل افتراضي */
        .modal { 
            display: none !important; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        /* إظهار النافذة النشطة فقط */
        .modal.show { 
            display: flex !important; 
            align-items: center;
            justify-content: center;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .subscription-card:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .price-option { transition: all 0.2s ease; }
        .price-option:hover { background-color: #f0f9ff; }
        .day-checkbox { transition: all 0.2s ease; }
        .day-checkbox:hover { background-color: #f3f4f6; }
        .image-preview { max-width: 300px; max-height: 200px; object-fit: contain; }
        .subscription-image { cursor: pointer; transition: transform 0.2s ease; }
        .subscription-image:hover { transform: scale(1.05); }
        
        /* تصميم منطقة التوقيع */
        .signature-pad {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: crosshair;
            background: #fafafa;
        }
        
        .signature-pad.signed {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        /* تصميم الطباعة المحدث لصفحة A4 واحدة */
        @media print {
            body * { visibility: hidden; }
            .print-content, .print-content * { visibility: visible; }
            
            .print-content { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                margin: 0;
                box-sizing: border-box;
            }
            .no-print { display: none !important; }
            
            .print-form-page {
                width: 100%;
                max-width: 180mm;
                margin: 0 auto;
                text-align: right;
                padding: 20mm;
                box-sizing: border-box;
            }
            
            .print-form-page .print-section {
                border: 1px solid #d1d5db !important;
                border-radius: 8px !important;
                background: none !important;
                padding: 1rem !important;
                margin-top: 1rem !important;
            }
            
            /* تعديل مهم هنا: لزيادة حجم الصورة */
            .print-schedule-page {
                width: 100%;
                height: 100vh; /* لضمان ملء الصفحة بالكامل عمودياً */
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0;
                padding: 0;
            }
            
            .print-schedule-image {
                max-width: 95%; /* زيادة الحجم الأقصى للصورة */
                max-height: 95vh;
                height: auto;
                object-fit: contain;
            }
            
            /* إضافة فاصل صفحات لكل صفحة طباعة */
            .print-page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- الصفحة الرئيسية -->
    <div id="mainPage" class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">🍃 استمارات الاشتراكات</h1>
            <p class="text-gray-600 text-lg">إدارة وعرض استمارات الاشتراكات المعتمدة</p>
        </div>

        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">الاستمارات المعتمدة</h2>
                    <button onclick="openNewSubscriptionForm()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 transform hover:scale-105">
                        ➕ إنشاء استمارة اشتراك جديدة
                    </button>
                </div>
                
                <div id="subscriptionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- سيتم عرض الاستمارات هنا -->
                    <div class="text-center py-12 col-span-full">
                        <div class="text-6xl mb-4">📋</div>
                        <p class="text-gray-500 text-lg">لا توجد استمارات معتمدة حتى الآن</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج الاشتراك الجديد / التعديل -->
    <div id="newSubscriptionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">📝 استمارة اشتراك جديدة</h2>
                    <button type="button" onclick="closeModal('newSubscriptionModal')" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center text-xl transition-colors">✕</button>
                </div>
            </div>

            <form id="subscriptionForm" class="p-6 space-y-6">
                <!-- حقل مخفي لتخزين معرف المستند في حالة التعديل -->
                <input type="hidden" id="subscriptionId">

                <!-- بيانات العميل -->
                <div class="bg-blue-50 rounded-xl p-6 border border-gray-300">
                    <h3 class="text-xl font-semibold text-blue-800 mb-4">👤 بيانات العميل</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اسم الزبون *</label>
                            <input type="text" id="customerName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف *</label>
                            <input type="text" id="phoneNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="مثال: ٩٦٥١٢٣٤٥٦٧٨" oninput="convertArabicToEnglish(this)">
                        </div>
                    </div>
                </div>

                <!-- العنوان -->
                <div class="bg-green-50 rounded-xl p-6 border border-gray-300">
                    <h3 class="text-xl font-semibold text-green-800 mb-4">🏠 العنوان</h3>
                    <div class="flex gap-4 mb-4">
                        <button type="button" onclick="selectAddressType('house')" id="houseBtn" class="flex-1 py-3 px-6 border-2 border-gray-300 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100">🏠 بيت</button>
                        <button type="button" onclick="selectAddressType('apartment')" id="apartmentBtn" class="flex-1 py-3 px-6 border-2 border-gray-300 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100">🏢 شقة</button>
                    </div>

                    <div id="addressFields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- سيتم إضافة حقول العنوان هنا -->
                    </div>
                </div>

                <!-- نوع الاشتراك -->
                <div class="bg-purple-50 rounded-xl p-6 border border-gray-300">
                    <h3 class="text-xl font-semibold text-purple-800 mb-4">📋 نوع الاشتراك</h3>
                    <div class="grid grid-cols-1 gap-4 max-h-96 overflow-y-auto">
                        <div id="subscriptionTypes"></div>
                    </div>
                </div>

                <!-- تفاصيل الاشتراك -->
                <div id="subscriptionDetails" class="bg-orange-50 rounded-xl p-6 hidden border border-gray-300">
                    <h3 class="text-xl font-semibold text-orange-800 mb-4">⏰ تفاصيل الاشتراك</h3>
                    
                    <div class="period-options-container"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ بدء الاشتراك *</label>
                            <input type="date" id="startDate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="calculateEndDate()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">وقت التوصيل *</label>
                            <select id="deliveryTime" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="">اختر وقت التوصيل</option>
                                <option value="9-12">من ٩ص الى ١٢ظ</option>
                                <option value="12-15">من ١٢ظ الى ٣م</option>
                                <option value="15-18">من ٣م الى ٦م</option>
                                <option value="18-21">من ٦م الى ٩م</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">الأيام المستبعدة من التوصيل</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2" id="weekDays">
                            <!-- سيتم إضافة أيام الأسبوع هنا -->
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">سعر التوصيل (د.ك)</label>
                            <input type="number" id="deliveryPrice" step="0.1" min="0" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="updateTotalPrice()">
                            <div id="freeDeliveryNote" class="text-sm text-green-600 mt-1 hidden">✅ التوصيل مجاني</div>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-2">ملخص الأسعار:</div>
                            <div class="space-y-1">
                                <div class="flex justify-between"><span>سعر الاشتراك:</span><span id="subscriptionPriceDisplay">0 د.ك</span></div>
                                <div class="flex justify-between"><span>سعر التوصيل:</span><span id="deliveryPriceDisplay">0 د.ك</span></div>
                                <div class="flex justify-between font-bold border-t pt-1"><span>الإجمالي:</span><span id="totalPriceDisplay">0 د.ك</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-blue-100 rounded-lg" id="datesSummary" style="display: none;">
                        <!-- سيتم عرض ملخص التواريخ هنا -->
                    </div>
                </div>

                <!-- أزرار الإجراءات -->
                <div class="flex gap-4 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeModal('newSubscriptionModal')" class="flex-1 py-3 px-6 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 hover:border-gray-400 transition-all duration-200">❌ إلغاء</button>
                    <button type="submit" id="submitBtn" class="flex-1 py-3 px-6 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-lg hover:shadow-xl">✅ إنشاء الاستمارة</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة التأكيد -->
    <div id="confirmationModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full m-4 p-8 text-center" onclick="event.stopPropagation()">
            <div class="text-6xl mb-4">🎉</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">شكراً لثقتكم</h2>
            <p class="text-gray-600 mb-6">تم اعتماد الاشتراك، يرجى المتابعة مع الموظف للدفع</p>
            <button onclick="closeModal('confirmationModal')" class="w-full py-3 px-6 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-300">
                حسناً
            </button>
        </div>
    </div>

    <!-- نافذة عرض الصورة -->
    <div id="imageModal" class="modal">
        <div class="relative" onclick="event.stopPropagation()">
            <img id="modalImage" src="" alt="صورة الاشتراك" class="rounded-lg shadow-2xl max-w-[90vw] max-h-[90vh] object-contain">
            <button type="button" onclick="closeModal('imageModal')" class="absolute top-4 right-4 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl transition-all">✕</button>
        </div>
    </div>

    <!-- منطقة الطباعة المخفية -->
    <div id="printArea" class="print-content hidden">
        <!-- سيتم إنشاء محتوى الطباعة هنا -->
    </div>

    <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBIP8ezD990c7kZ3z-gsma2KJpp7Zqu7eA",
            authDomain: "ishtrakta.firebaseapp.com",
            databaseURL: "https://ishtrakta-default-rtdb.firebaseio.com",
            projectId: "ishtrakta",
            storageBucket: "ishtrakta.firebasestorage.app",
            messagingSenderId: "854766859254",
            appId: "1:854766859254:web:0375c2c8c9c518b2f74dd7",
            measurementId: "G-QT71DGNRXT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // بيانات الاشتراكات
        const subscriptionTypes = [
            { id: 1, name: "اشتراك إنقاص الوزن النباتي", prices: { week: 87.5, twoWeeks: 120, month: 240 }, image: "a1.jpg" },
            { id: 2, name: "اشتراك إنقاص الوزن", prices: { week: 93.5, twoWeeks: 130, month: 250 }, image: "a2.jpg" },
            { id: 3, name: "اشتراك خاص لرفع المناعة", prices: { week: 95, twoWeeks: 145, month: 280 }, image: "a3.jpg" },
            { id: 4, name: "اشتراك نظام الكيتو", prices: { week: 95, twoWeeks: 140, month: 280 }, image: "a4.jpg" },
            { id: 5, name: "اشتراك خالي من الجلوتين", prices: { week: 93.5, twoWeeks: 130, month: 260 }, image: "a5.jpg" },
            { id: 6, name: "اشتراك خالي من الجلوتين ومنتجات الألبان", prices: { week: 91.5, twoWeeks: 128.5, month: 255 }, image: "a6.jpg" },
            { id: 7, name: "اشتراك التخلص من الالتهابات في الجسم بالصيام المتقطع", prices: { tenDays: 120, twentyDays: 200, thirtyDays: 290 }, image: "a7.jpg", note: "مع اشتراك التلقرام الذي قيمته ٥٠ دينار مجاناً لاشتراك الشهر فقط" },
            { id: 8, name: "اشتراك التخلص من الإلتهابات بدون صيام", prices: { tenDays: 130, twentyDays: 210, thirtyDays: 300 }, image: "a8.jpg", note: "مع اشتراك التلقرام الذي قيمته ٥٠ دينار مجاناً لاشتراك الشهر فقط" },
            { id: 9, name: "اشتراك رمضان", prices: { week: 90, twoWeeks: 140, month: 240 }, image: "a9.jpg" },
            { id: 10, name: "اشتراك رمضان النباتي", prices: { week: 80, twoWeeks: 130, month: 230 }, image: "a10.jpg" },
            { id: 11, name: "اشتراك رفع نسب امتصاص الفيتامينت، والمعادن (يصلح للنساء الحامل)", prices: { week: 93.5, twoWeeks: 130, month: 250 }, image: "a11.jpg" },
            { id: 12, name: "اشتراك خاص للنساء المرضعات", prices: { week: 93.5, twoWeeks: 130, month: 260 }, image: "a12.jpg" },
            { id: 13, name: "اشتراك ضد أنواع الحساسيات الشائعة", prices: { week: 96.5, twoWeeks: 133.5, month: 260 }, image: "a13.jpg" },
            { id: 14, name: "اشتراك خاص للرياضيين", prices: { tenDays: 120, twentyDays: 180, thirtyDays: 230 }, image: "a14.jpg" },
            { id: 15, name: "اسلوب الحياة الصحية (غير مخصص لخسارة الوزن)", prices: { tenDays: 120, twentyDays: 180, thirtyDays: 230 }, image: "a15.jpg" },
            { id: 16, name: "اشتراك الأخصائية ريم العنزي، محسوب السعرات", prices: { tenDays: 150, twentyDays: 200, thirtyDays: 230 }, image: "a16.jpg" },
            { id: 17, name: "اشتراك ريوق المستشفى", prices: { week: 50, twoWeeks: 80, month: 120 }, image: "a17.jpg" },
            { id: 18, name: "اشتراك مخصص", prices: { custom: true }, image: null, isCustom: true }
        ];

        // المتغيرات العامة لحالة النموذج
        let selectedSubscription = null;
        let selectedPeriod = null;
        let selectedPrice = 0;
        let addressType = null;
        let excludedDays = [];
        let editingSubscriptionId = null; // لتخزين معرف الاشتراك عند التعديل
        let customImageFile = null; // لتخزين ملف الصورة المخصصة

        // تحويل الأرقام العربية إلى إنجليزية
        function convertArabicToEnglish(input) {
            const arabicNumbers = '٠١٢٣٤٥٦٧٨٩';
            const englishNumbers = '0123456789';
            let value = input.value;
            
            for (let i = 0; i < arabicNumbers.length; i++) {
                value = value.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
            }
            
            input.value = value;
        }

        // فتح النافذة
        function openModal(modalId) {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
            
            setTimeout(() => {
                document.getElementById(modalId).classList.add('show');
            }, 100);
        }

        // إغلاق النافذة
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            
            if (modalId === 'newSubscriptionModal') {
                resetForm();
            }
        }

        // فتح نموذج الاشتراك الجديد
        function openNewSubscriptionForm() {
            editingSubscriptionId = null;
            document.getElementById('modalTitle').textContent = '📝 استمارة اشتراك جديدة';
            document.getElementById('submitBtn').textContent = '✅ إنشاء الاستمارة';
            openModal('newSubscriptionModal');
            initializeSubscriptionTypes();
            initializeWeekDays();
        }

        // إعادة تعيين النموذج
        function resetForm() {
            selectedSubscription = null;
            selectedPeriod = null;
            selectedPrice = 0;
            addressType = null;
            excludedDays = [];
            customImageFile = null;

            document.getElementById('subscriptionForm').reset();
            document.getElementById('subscriptionId').value = '';
            document.getElementById('subscriptionDetails').classList.add('hidden');
            document.getElementById('addressFields').innerHTML = '';

            // إزالة التحديدات
            document.querySelectorAll('.subscription-card').forEach(card => card.classList.remove('border-purple-500', 'bg-purple-50', 'shadow-lg'));
            document.querySelectorAll('.price-option').forEach(option => option.classList.remove('border-orange-500', 'bg-orange-50'));
            
            // إعادة تعيين أزرار العنوان
            document.getElementById('houseBtn').className = 'flex-1 py-3 px-6 border-2 border-gray-300 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100';
            document.getElementById('apartmentBtn').className = 'flex-1 py-3 px-6 border-2 border-gray-300 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100';
            
            updateTotalPrice();
        }

        // اختيار نوع العنوان
        function selectAddressType(type) {
            addressType = type;
            const houseBtn = document.getElementById('houseBtn');
            const apartmentBtn = document.getElementById('apartmentBtn');
            
            houseBtn.classList.remove('border-green-500', 'bg-green-100');
            apartmentBtn.classList.remove('border-green-500', 'bg-green-100');

            if (type === 'house') {
                houseBtn.classList.add('border-green-500', 'bg-green-100');
            } else {
                apartmentBtn.classList.add('border-green-500', 'bg-green-100');
            }
            
            generateAddressFields(type);
        }

        // إنشاء حقول العنوان
        function generateAddressFields(type, data = {}) {
            const addressFields = document.getElementById('addressFields');
            let fieldsHtml = '';
            
            if (type === 'house') {
                fieldsHtml = `
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">المنطقة *</label><input type="text" id="area" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.area || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">القطعة *</label><input type="text" id="block" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.block || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الشارع *</label><input type="text" id="street" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.street || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الجادة (إن وجدت)</label><input type="text" id="avenue" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.avenue || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">رقم المنزل *</label><input type="text" id="houseNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.houseNumber || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">مبنى مجاور؟ (اختياري)</label><input type="text" id="nearbyBuilding" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.nearbyBuilding || ''}"></div>
                `;
            } else if (type === 'apartment') {
                fieldsHtml = `
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">المنطقة *</label><input type="text" id="area" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.area || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">القطعة *</label><input type="text" id="block" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.block || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الشارع *</label><input type="text" id="street" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.street || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الجادة (إن وجدت)</label><input type="text" id="avenue" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.avenue || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">رقم/اسم البناية *</label><input type="text" id="buildingName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.buildingName || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الطابق *</label><input type="text" id="floor" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.floor || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الشقة *</label><input type="text" id="apartment" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.apartment || ''}"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">مبنى مجاور؟ (اختياري)</label><input type="text" id="nearbyBuilding" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${data.nearbyBuilding || ''}"></div>
                `;
            }
            addressFields.innerHTML = fieldsHtml;
        }

        // تهيئة أنواع الاشتراكات
        function initializeSubscriptionTypes(selectedId = null) {
            const container = document.getElementById('subscriptionTypes');
            container.innerHTML = '';
            
            subscriptionTypes.forEach(subscription => {
                const div = document.createElement('div');
                div.className = `subscription-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all duration-200 hover:shadow-lg ${selectedId === subscription.id ? 'border-purple-500 bg-purple-50 shadow-lg' : ''}`;
                div.onclick = () => selectSubscription(subscription);
                
                let pricesHtml = '';
                // تم تعديل المسار هنا
                const imageUrl = subscription.image ? `./${subscription.image}` : '';
                
                if (subscription.isCustom) {
                    pricesHtml = '<div class="text-sm text-gray-600">سعر مخصص</div>';
                } else {
                    const prices = subscription.prices;
                    const periodKeys = Object.keys(prices);
                    pricesHtml = periodKeys.map(key => {
                        return `${getPeriodText(key)}: ${prices[key]} د.ك`;
                    }).join(' | ');
                    pricesHtml = `<div class="text-sm text-gray-600">${pricesHtml}</div>`;
                }
                
                div.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-2">${subscription.name}</h4>
                            ${pricesHtml}
                            ${subscription.note ? `<div class="text-xs text-blue-600 mt-1">${subscription.note}</div>` : ''}
                        </div>
                        ${imageUrl ? `<img src="${imageUrl}" alt="صورة الاشتراك" class="subscription-image w-16 h-16 object-cover rounded-lg" onclick="event.stopPropagation(); showImage('${imageUrl}')">` : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // اختيار الاشتراك
        function selectSubscription(subscription) {
            selectedSubscription = subscription;
            
            document.querySelectorAll('.subscription-card').forEach(card => {
                card.classList.remove('border-purple-500', 'bg-purple-50', 'shadow-lg');
            });
            event.currentTarget.classList.add('border-purple-500', 'bg-purple-50', 'shadow-lg');
            
            showPeriodOptions(subscription);
        }

        // عرض خيارات الفترة
        function showPeriodOptions(subscription, selectedPeriodKey = null) {
            const detailsDiv = document.getElementById('subscriptionDetails');
            detailsDiv.classList.remove('hidden');
            
            let periodContainer = detailsDiv.querySelector('.period-options-container');
            if (!periodContainer) {
                periodContainer = document.createElement('div');
                periodContainer.className = 'period-options-container';
                const firstChild = detailsDiv.querySelector('h3').nextElementSibling;
                detailsDiv.insertBefore(periodContainer, firstChild);
            }
            
            let periodOptionsHtml = '<div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-3">اختر فترة الاشتراك *</label><div class="grid grid-cols-1 md:grid-cols-3 gap-3">';
            
            if (subscription.isCustom) {
                const periods = ['week', 'twoWeeks', 'fourWeeks', 'tenDays', 'twentyDays', 'thirtyDays'];
                periodOptionsHtml += periods.map(p => `
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center ${selectedPeriodKey === p ? 'border-orange-500 bg-orange-50' : ''}" onclick="selectPeriod('${p}', 0)">
                        <div class="font-semibold">${getPeriodText(p)}</div>
                        <div class="text-sm text-gray-600">سعر مخصص</div>
                    </div>
                `).join('');
                
                periodOptionsHtml += '</div></div>';
                
                periodOptionsHtml += `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">السعر المخصص (د.ك) *</label>
                        <input type="number" id="customPrice" step="0.1" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="updateCustomPrice()">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">صورة جدول الاشتراك *</label>
                        <input type="file" id="customImage" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="previewCustomImage()">
                        <div id="imagePreview" class="mt-2"></div>
                    </div>
                `;
            } else {
                const prices = subscription.prices;
                const periodKeys = Object.keys(prices);
                periodOptionsHtml += periodKeys.map(key => `
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center ${selectedPeriodKey === key ? 'border-orange-500 bg-orange-50' : ''}" onclick="selectPeriod('${key}', ${prices[key]})">
                        <div class="font-semibold">${getPeriodText(key)}</div>
                        <div class="text-sm text-gray-600">${prices[key]} د.ك</div>
                    </div>
                `).join('');
                periodOptionsHtml += '</div></div>';
            }
            
            periodContainer.innerHTML = periodOptionsHtml;
        }

        // اختيار الفترة
        function selectPeriod(period, price) {
            selectedPeriod = period;
            selectedPrice = price;
            
            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('border-orange-500', 'bg-orange-50');
            });
            event.currentTarget.classList.add('border-orange-500', 'bg-orange-50');
            
            updateTotalPrice();
        }

        // تحديث السعر المخصص
        function updateCustomPrice() {
            const customPrice = parseFloat(document.getElementById('customPrice').value) || 0;
            selectedPrice = customPrice;
            updateTotalPrice();
        }

        // معاينة الصورة المخصصة
        function previewCustomImage(file = null, url = null) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = ''; // مسح أي معاينة سابقة

            if (file) {
                customImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="معاينة الصورة" class="image-preview rounded-lg border">`;
                };
                reader.readAsDataURL(file);
            } else if (url) {
                preview.innerHTML = `<img src="${url}" alt="معاينة الصورة" class="image-preview rounded-lg border">`;
            } else {
                customImageFile = document.getElementById('customImage').files[0];
                if (customImageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="معاينة الصورة" class="image-preview rounded-lg border">`;
                    };
                    reader.readAsDataURL(customImageFile);
                }
            }
        }

        // تهيئة أيام الأسبوع
        function initializeWeekDays(excluded = []) {
            const weekDays = ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];
            const container = document.getElementById('weekDays');
            container.innerHTML = '';
            excludedDays = excluded;
            
            weekDays.forEach((day, index) => {
                const isExcluded = excluded.includes(index);
                const div = document.createElement('div');
                div.className = `day-checkbox flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer ${isExcluded ? 'border-red-300 bg-red-50' : ''}`;
                div.onclick = () => toggleDay(index, div);
                div.innerHTML = `
                    <input type="checkbox" id="day${index}" ${isExcluded ? '' : 'checked'} class="mr-2">
                    <label for="day${index}" class="text-sm cursor-pointer">${day}</label>
                `;
                container.appendChild(div);
            });
        }

        // تبديل اليوم (تم تحديث هذه الدالة لمنع التكرار)
        function toggleDay(dayIndex, element) {
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            
            const indexInArray = excludedDays.indexOf(dayIndex);

            if (checkbox.checked) {
                // إذا كان موجودًا في القائمة المستبعدة، قم بإزالته
                if (indexInArray !== -1) {
                    excludedDays.splice(indexInArray, 1);
                }
                element.classList.remove('border-red-300', 'bg-red-50');
            } else {
                // إذا لم يكن موجودًا في القائمة، قم بإضافته
                if (indexInArray === -1) {
                    excludedDays.push(dayIndex);
                }
                element.classList.add('border-red-300', 'bg-red-50');
            }
            
            calculateEndDate();
        }

        // دالة مساعدة لحساب تاريخ الانتهاء
        function getEndDate(startDate, period, excludedDays) {
            if (!startDate || !period) return null;
            
            const start = new Date(startDate);
            let duration = 0;
            
            switch (period) {
                case 'week': duration = 7; break;
                case 'twoWeeks': duration = 14; break;
                case 'month': duration = 28; break;
                case 'fourWeeks': duration = 28; break;
                case 'tenDays': duration = 10; break;
                case 'twentyDays': duration = 20; break;
                case 'thirtyDays': duration = 30; break;
            }
            
            if (duration === 0) return null;
            
            let currentDate = new Date(start);
            let deliveryDays = 0;
            
            while (deliveryDays < duration) {
                if (!excludedDays.includes(currentDate.getDay())) {
                    deliveryDays++;
                }
                if (deliveryDays < duration) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            return currentDate;
        }

        // حساب تاريخ الانتهاء وعرضه
        function calculateEndDate() {
            const startDateInput = document.getElementById('startDate');
            if (!startDateInput.value || !selectedPeriod) return;

            const startDate = new Date(startDateInput.value);
            const endDate = getEndDate(startDate, selectedPeriod, excludedDays);
            
            const summary = document.getElementById('datesSummary');
            summary.style.display = 'block';
            summary.innerHTML = `
                <div class="font-semibold text-blue-800 mb-2">📅 ملخص التواريخ:</div>
                <div class="space-y-1 text-sm">
                    <div><strong>تاريخ البدء:</strong> ${startDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' })}</div>
                    <div><strong>تاريخ الانتهاء:</strong> ${endDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' })}</div>
                    <div><strong>عدد أيام التوصيل:</strong> ${getDuration(selectedPeriod)} يوم</div>
                    ${excludedDays.length > 0 ? `<div><strong>الأيام المستبعدة:</strong> ${excludedDays.map(day => ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'][day]).join(', ')}</div>` : ''}
                </div>
            `;
        }

        // دالة مساعدة للحصول على مدة الاشتراك بالأيام
        function getDuration(period) {
            switch (period) {
                case 'week': return 7;
                case 'twoWeeks': return 14;
                case 'month': return 28;
                case 'fourWeeks': return 28;
                case 'tenDays': return 10;
                case 'twentyDays': return 20;
                case 'thirtyDays': return 30;
                default: return 0;
            }
        }

        // تحديث السعر الإجمالي
        function updateTotalPrice() {
            const deliveryPrice = parseFloat(document.getElementById('deliveryPrice').value) || 0;
            const totalPrice = selectedPrice + deliveryPrice;
            
            document.getElementById('subscriptionPriceDisplay').textContent = selectedPrice + ' د.ك';
            document.getElementById('deliveryPriceDisplay').textContent = deliveryPrice + ' د.ك';
            document.getElementById('totalPriceDisplay').textContent = totalPrice + ' د.ك';
            
            const freeDeliveryNote = document.getElementById('freeDeliveryNote');
            if (deliveryPrice === 0) {
                freeDeliveryNote.classList.remove('hidden');
            } else {
                freeDeliveryNote.classList.add('hidden');
            }
        }

        // عرض الصورة
        function showImage(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            openModal('imageModal');
        }

        // إرسال النموذج
        document.getElementById('subscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedSubscription || !selectedPeriod || !addressType) {
                alert('يرجى إكمال جميع البيانات المطلوبة');
                return;
            }
            
            const subscriptionId = document.getElementById('subscriptionId').value;
            const isEditing = !!subscriptionId;
            let customImageUrl = null;

            if (selectedSubscription.isCustom && customImageFile) {
                try {
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`custom_images/${customImageFile.name}_${new Date().getTime()}`);
                    const snapshot = await imageRef.put(customImageFile);
                    customImageUrl = await snapshot.ref.getDownloadURL();
                } catch (error) {
                    console.error('Error uploading custom image:', error);
                    alert('حدث خطأ في رفع الصورة المخصصة. يرجى المحاولة مرة أخرى.');
                    return;
                }
            } else if (isEditing && selectedSubscription.isCustom && selectedSubscription.image) {
                customImageUrl = selectedSubscription.image;
            }

            // جمع البيانات
            const formData = {
                customerName: document.getElementById('customerName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                addressType: addressType,
                address: getAddressData(),
                subscription: {
                    ...selectedSubscription,
                    image: customImageUrl || (selectedSubscription.image ? `./${selectedSubscription.image}` : null)
                },
                period: selectedPeriod,
                price: selectedPrice,
                startDate: document.getElementById('startDate').value,
                deliveryTime: document.getElementById('deliveryTime').value,
                excludedDays: excludedDays,
                deliveryPrice: parseFloat(document.getElementById('deliveryPrice').value) || 0,
                totalPrice: selectedPrice + (parseFloat(document.getElementById('deliveryPrice').value) || 0),
            };

            if (!isEditing) {
                formData.createdAt = new Date();
                formData.status = 'pending';
            }
            
            try {
                if (isEditing) {
                    await db.collection('subscriptions').doc(subscriptionId).update(formData);
                } else {
                    const docRef = await db.collection('subscriptions').add(formData);
                    formData.id = docRef.id;
                }
                
                // إنشاء رابط العميل - رابط كامل للواتساب
                const customerLink = `https://figsandolives.github.io/ishtrak/sign.html?customer=${formData.id || subscriptionId}`;
                
                // إنشاء رسالة الواتساب
                const whatsappMessage = `تم تعبئة بيانات استمارة الاشتراك بنجاح،
يرجى الضغط على الرابط التالي للاعتماد والتوقيع:
${customerLink}`;
                
                // تنظيف رقم الهاتف وإنشاء رابط الواتساب
                const cleanPhone = formData.phoneNumber.replace(/[^\d]/g, '');
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(whatsappMessage)}`;
                
                // إغلاق النموذج
                closeModal('newSubscriptionModal');
                
                // فتح الواتساب في نافذة جديدة
                window.open(whatsappUrl, '_blank');
                
                alert('تم إنشاء/تحديث الاستمارة بنجاح! تم فتح الواتساب لإرسال الرابط للعميل.');
                
                // تحديث قائمة الاستمارات
                loadSubscriptions();
                
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                alert('حدث خطأ في إنشاء الاستمارة. يرجى المحاولة مرة أخرى.');
            }
        });

        // الحصول على بيانات العنوان
        function getAddressData() {
            const address = {
                area: document.getElementById('area')?.value,
                block: document.getElementById('block')?.value,
                street: document.getElementById('street')?.value,
                avenue: document.getElementById('avenue')?.value || '',
                nearbyBuilding: document.getElementById('nearbyBuilding')?.value || ''
            };
            
            if (addressType === 'house') {
                address.houseNumber = document.getElementById('houseNumber')?.value;
            } else {
                address.buildingName = document.getElementById('buildingName')?.value;
                address.floor = document.getElementById('floor')?.value;
                address.apartment = document.getElementById('apartment')?.value;
            }
            
            return address;
        }

        // تحميل الاستمارات المحفوظة
        async function loadSubscriptions() {
            try {
                const snapshot = await db.collection('subscriptions').orderBy('createdAt', 'desc').get();
                const subscriptionsList = document.getElementById('subscriptionsList');
                
                if (snapshot.empty) {
                    subscriptionsList.innerHTML = `
                        <div class="text-center py-12 col-span-full">
                            <div class="text-6xl mb-4">📋</div>
                            <p class="text-gray-500 text-lg">لا توجد استمارات معتمدة حتى الآن</p>
                        </div>
                    `;
                    return;
                }
                
                subscriptionsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow';
                    
                    // تحويل كائن Firestore Timestamp إلى كائن Date
                    const createdAtDate = data.createdAt ? new Date(data.createdAt.seconds * 1000) : new Date();

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-semibold text-lg text-gray-800">${data.customerName}</h3>
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${data.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${data.status === 'approved' ? 'معتمد' : 'في الانتظار'}</span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                            <div><strong>تاريخ الإنشاء:</strong> ${createdAtDate.toLocaleDateString('ar-EG', { year: 'numeric', month: 'numeric', day: 'numeric' })}</div>
                            <div><strong>الهاتف:</strong> ${data.phoneNumber}</div>
                            <div><strong>الاشتراك:</strong> ${data.subscription.name}</div>
                            <div><strong>المدة:</strong> ${getPeriodText(data.period)}</div>
                            <div><strong>السعر:</strong> ${data.totalPrice} د.ك</div>
                            <div><strong>تاريخ البدء:</strong> ${new Date(data.startDate).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' })}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="sendToCustomer('${doc.id}', '${data.phoneNumber}')" class="flex-1 py-2 px-4 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">📤 إرسال للعميل</button>
                            <button onclick="editSubscription('${doc.id}')" class="flex-1 py-2 px-4 bg-yellow-500 text-white rounded-lg text-sm hover:bg-yellow-600 transition-colors">✏️ تعديل</button>
                            <button onclick="deleteSubscription('${doc.id}')" class="flex-1 py-2 px-4 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-colors">🗑️ حذف</button>
                            ${data.status === 'approved' ? `<button onclick="printSubscription('${doc.id}')" class="py-2 px-4 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-colors">🖨️ طباعة</button>` : ''}
                        </div>
                    `;
                    subscriptionsList.appendChild(div);
                });
                
            } catch (error) {
                console.error('خطأ في تحميل الاستمارات:', error);
            }
        }

        // إرسال للعميل
        function sendToCustomer(id, phoneNumber) {
            const customerLink = `https://figsandolives.github.io/ishtrak/sign.html?customer=${id}`;
            const whatsappMessage = `تم تعبئة بيانات استمارة الاشتراك بنجاح،
يرجى الضغط على الرابط التالي للاعتماد والتوقيع:
${customerLink}`;
            const cleanPhone = phoneNumber.replace(/[^\d]/g, '');
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(whatsappMessage)}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // تعديل الاشتراك
        async function editSubscription(id) {
            try {
                const doc = await db.collection('subscriptions').doc(id).get();
                if (!doc.exists) {
                    alert('الاشتراك غير موجود');
                    return;
                }
                const data = doc.data();

                // تهيئة النموذج للوضع التعديل
                editingSubscriptionId = id;
                document.getElementById('subscriptionId').value = id;
                document.getElementById('modalTitle').textContent = '✏️ تعديل استمارة الاشتراك';
                document.getElementById('submitBtn').textContent = '✅ تحديث الاستمارة';
                openModal('newSubscriptionModal');

                // تعبئة البيانات في النموذج
                document.getElementById('customerName').value = data.customerName;
                document.getElementById('phoneNumber').value = data.phoneNumber;
                selectAddressType(data.addressType);
                generateAddressFields(data.addressType, data.address);
                initializeSubscriptionTypes(data.subscription.id);
                selectSubscription(subscriptionTypes.find(s => s.id === data.subscription.id));
                selectPeriod(data.period, data.price);
                document.getElementById('startDate').value = data.startDate;
                document.getElementById('deliveryTime').value = data.deliveryTime;
                initializeWeekDays(data.excludedDays);
                document.getElementById('deliveryPrice').value = data.deliveryPrice;
                updateTotalPrice();
                calculateEndDate();

            } catch (error) {
                console.error('خطأ في تعديل الاشتراك:', error);
                alert('حدث خطأ أثناء محاولة تعديل الاشتراك.');
            }
        }

        // حذف الاشتراك
        async function deleteSubscription(id) {
            if (confirm('هل أنت متأكد من حذف هذا الاشتراك؟')) {
                try {
                    await db.collection('subscriptions').doc(id).delete();
                    loadSubscriptions();
                    alert('تم حذف الاشتراك بنجاح');
                } catch (error) {
                    console.error('خطأ في حذف الاشتراك:', error);
                    alert('حدث خطأ في حذف الاشتراك');
                }
            }
        }

        // طباعة الاشتراك
        async function printSubscription(id) {
            try {
                const doc = await db.collection('subscriptions').doc(id).get();
                if (!doc.exists) {
                    alert('الاشتراك غير موجود');
                    return;
                }
                
                const data = doc.data();
                
                // تحديد عدد المرات التي سيتكرر فيها المحتوى بناءً على مدة الاشتراك
                let repeatCount = 1;
                switch (data.period) {
                    case 'week':
                    case 'tenDays':
                        repeatCount = 1;
                        break;
                    case 'twoWeeks':
                    case 'twentyDays':
                        repeatCount = 2;
                        break;
                    case 'fourWeeks':
                    case 'thirtyDays':
                    case 'month':
                        repeatCount = 3;
                        break;
                }

                await generatePrintContent(data, repeatCount);
                
                // يتم إخفاء المحتوى الرئيسي وعرض المحتوى المخصص للطباعة فقط
                document.getElementById('mainPage').classList.add('hidden');
                document.getElementById('printArea').classList.remove('hidden');

                setTimeout(() => {
                    window.print();
                    // بعد الطباعة أو الإلغاء، يتم إعادة إظهار المحتوى الرئيسي
                    document.getElementById('mainPage').classList.remove('hidden');
                    document.getElementById('printArea').classList.add('hidden');
                    document.getElementById('printArea').innerHTML = ''; // تنظيف المحتوى
                }, 500);
                
            } catch (error) {
                console.error('خطأ في طباعة الاشتراك:', error);
                alert('حدث خطأ في طباعة الاشتراك');
            }
        }

        // دالة جديدة لتنسيق نطاق الوقت
        function formatDeliveryTimeRange(timeRange) {
            const [start, end] = timeRange.split('-');
            
            let startHour = parseInt(start);
            let endHour = parseInt(end);

            let startPeriod = startHour < 12 ? 'صباحاً' : 'ظهراً';
            let endPeriod = endHour < 12 ? 'صباحاً' : (endHour === 12 ? 'ظهراً' : 'مساءً');

            let start12 = startHour > 12 ? startHour - 12 : startHour;
            let end12 = endHour > 12 ? endHour - 12 : endHour;
            if (start12 === 0) start12 = 12; // 12 AM
            if (end12 === 0) end12 = 12; // 12 AM
            if (startHour === 12) startPeriod = 'ظهراً'; // 12 PM
            if (endHour === 12) endPeriod = 'ظهراً'; // 12 PM
            
            // تحويل الأرقام الإنجليزية إلى عربية
            const toArabicNumerals = (num) => num.toString().replace(/\d/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
            
            return `من ${toArabicNumerals(start12)} ${startPeriod} إلى ${toArabicNumerals(end12)} ${endPeriod}`;
        }


        // إنشاء محتوى الطباعة
        async function generatePrintContent(data, repeatCount) {
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = ''; // تنظيف المحتوى القديم
            
            const startDateFormatted = new Date(data.startDate).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' });
            const startDateObj = new Date(data.startDate);
            const endDateObj = getEndDate(startDateObj, data.period, data.excludedDays);
            const endDateFormatted = endDateObj.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' });
            
            // --- إنشاء محتوى الصفحة الأولى (الاستمارة الكاملة) ---
            const mainPageHtml = `
                <div class="print-form-page print-page-break">
                    <div class="text-center mb-4">
                        <h1 class="text-3xl font-bold mb-1">استمارة اشتراك</h1>
                        <p class="text-sm text-gray-600">رقم الاستمارة: ${Math.floor(Math.random() * 10000) + 1000}</p>
                    </div>
                    
                    <!-- بيانات العميل -->
                    <div class="print-section">
                        <h3 class="text-lg font-semibold mb-2 text-blue-800">بيانات العميل</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><strong>الاسم:</strong> ${data.customerName}</div>
                            <div><strong>الهاتف:</strong> ${data.phoneNumber}</div>
                        </div>
                    </div>
                    
                    <!-- العنوان -->
                    <div class="print-section mt-4">
                        <h3 class="text-lg font-semibold mb-2 text-green-800">العنوان</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><strong>النوع:</strong> ${data.addressType === 'house' ? 'بيت' : 'شقة'}</div>
                            <div><strong>المنطقة:</strong> ${data.address.area}</div>
                            <div><strong>القطعة:</strong> ${data.address.block}</div>
                            <div><strong>الشارع:</strong> ${data.address.street}</div>
                            ${data.address.avenue ? `<div><strong>الجادة:</strong> ${data.address.avenue}</div>` : ''}
                            ${data.addressType === 'house' ? 
                                `<div><strong>رقم المنزل:</strong> ${data.address.houseNumber}</div>` :
                                `<div><strong>البناية:</strong> ${data.address.buildingName}</div>
                                 <div><strong>الطابق:</strong> ${data.address.floor}</div>
                                 <div><strong>الشقة:</strong> ${data.address.apartment}</div>`
                            }
                        </div>
                    </div>
                    
                    <!-- تفاصيل الاشتراك -->
                    <div class="print-section mt-4">
                        <h3 class="text-lg font-semibold mb-2 text-purple-800">تفاصيل الاشتراك</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><strong>نوع الاشتراك:</strong> ${data.subscription.name}</div>
                            <div><strong>المدة:</strong> ${getPeriodText(data.period)}</div>
                            <div><strong>تاريخ البدء:</strong> ${startDateFormatted}</div>
                            <div><strong>تاريخ الانتهاء:</strong> ${endDateFormatted}</div>
                            <div><strong>وقت التوصيل:</strong> ${formatDeliveryTimeRange(data.deliveryTime)}</div>
                            <div><strong>الإجمالي:</strong> ${data.totalPrice} د.ك</div>
                            ${data.excludedDays.length > 0 ? `<div class="col-span-2"><strong>الأيام المستبعدة:</strong> ${[...new Set(data.excludedDays)].map(day => ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'][day]).join(', ')}</div>` : ''}
                        </div>
                    </div>

                    <!-- الشروط والأحكام -->
                    <div class="print-section mt-4">
                        <h3 class="text-lg font-semibold mb-2 text-red-800">الشروط والأحكام</h3>
                        <div class="space-y-1 text-xs">
                            <div>• المبلغ المدفوع لا يسترد.</div>
                            <div>• إذا تم إلغاء الاشتراك لأي سبب كان من طرف العميل يتم حساب المبلغ المتبقي من الاشتراك ويصبح كوبون مشتريات للعميل يمكنه الشراء به من مخبز التين والزيتون أو مطعم التين الطبيعي في أي وقت.</div>
                        </div>
                    </div>
                    
                    <!-- التوقيع -->
                    <div class="print-section mt-4">
                        <h3 class="text-lg font-semibold mb-2">توقيع العميل</h3>
                        ${data.signatureURL ? `<img src="${data.signatureURL}" alt="توقيع العميل" class="border border-gray-300 rounded max-h-32 w-full object-contain">` : '<div class="border border-gray-300 rounded h-32 flex items-center justify-center text-gray-500">لا يوجد توقيع</div>'}
                    </div>
                </div>
            `;
            
            printArea.innerHTML += mainPageHtml;
            
            // --- تكرار جدول الاشتراك في الصفحات التالية (بدون إطار أو عنوان) ---
            if (data.subscription.image) {
                for (let i = 0; i < repeatCount; i++) {
                    const tablePageHtml = `
                        <div class="print-schedule-page print-page-break">
                            <img src="${data.subscription.image}" alt="جدول الاشتراك" class="print-schedule-image">
                        </div>
                    `;
                    printArea.innerHTML += tablePageHtml;
                }
            }
        }


        // الحصول على نص الفترة
        function getPeriodText(period) {
            const periods = {
                'week': 'أسبوع',
                'twoWeeks': 'أسبوعين',
                'fourWeeks': '٤ أسابيع',
                'month': 'شهر',
                'tenDays': '١٠ أيام',
                'twentyDays': '٢٠ يوم',
                'thirtyDays': '٣٠ يوم',
                'custom': 'مخصص'
            };
            return periods[period] || period;
        }

        // إغلاق النوافذ بمفتاح الهروب
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const activeModal = document.querySelector('.modal.show');
                if (activeModal) {
                    closeModal(activeModal.id);
                }
            }
        });

        // إغلاق النوافذ بالضغط على الخلفية
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal') && event.target.classList.contains('show')) {
                closeModal(event.target.id);
            }
        });
        
        // تحميل الاستمارات عند تحميل الصفحة
        window.addEventListener('load', loadSubscriptions);
    </script>
</body>
</html>
