<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استمارات الاشتراكات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        
        /* إخفاء جميع النوافذ بشكل افتراضي */
        .modal { 
            display: none !important; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        /* إظهار النافذة النشطة فقط */
        .modal.show { 
            display: flex !important; 
            align-items: center;
            justify-content: center;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .subscription-card:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .price-option { transition: all 0.2s ease; }
        .price-option:hover { background-color: #f0f9ff; }
        .day-checkbox { transition: all 0.2s ease; }
        .day-checkbox:hover { background-color: #f3f4f6; }
        .image-preview { max-width: 300px; max-height: 200px; object-fit: contain; }
        .subscription-image { cursor: pointer; transition: transform 0.2s ease; }
        .subscription-image:hover { transform: scale(1.05); }
        
        /* تصميم منطقة التوقيع */
        .signature-pad {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: crosshair;
            background: #fafafa;
        }
        
        .signature-pad.signed {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        /* تصميم الطباعة */
        @media print {
            body * { visibility: hidden; }
            .print-content, .print-content * { visibility: visible; }
            .print-content { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
        
        .print-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            page-break-after: always;
        }
        
        .print-page:last-child {
            page-break-after: auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- الصفحة الرئيسية -->
    <div id="mainPage" class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">🍃 استمارات الاشتراكات</h1>
            <p class="text-gray-600 text-lg">إدارة وعرض استمارات الاشتراكات المعتمدة</p>
        </div>

        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">الاستمارات المعتمدة</h2>
                    <button onclick="openNewSubscriptionForm()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition-all duration-300 transform hover:scale-105">
                        ➕ إنشاء استمارة اشتراك جديدة
                    </button>
                </div>
                
                <div id="subscriptionsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- سيتم عرض الاستمارات هنا -->
                    <div class="text-center py-12 col-span-full">
                        <div class="text-6xl mb-4">📋</div>
                        <p class="text-gray-500 text-lg">لا توجد استمارات معتمدة حتى الآن</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج الاشتراك الجديد -->
    <div id="newSubscriptionModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">📝 استمارة اشتراك جديدة</h2>
                    <button type="button" onclick="closeModal('newSubscriptionModal')" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center text-xl transition-colors">✕</button>
                </div>
            </div>

            <form id="subscriptionForm" class="p-6 space-y-6">
                <!-- بيانات العميل -->
                <div class="bg-blue-50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-blue-800 mb-4">👤 بيانات العميل</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اسم الزبون *</label>
                            <input type="text" id="customerName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف *</label>
                            <input type="text" id="phoneNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="مثال: ٩٦٥١٢٣٤٥٦٧٨" oninput="convertArabicToEnglish(this)">
                        </div>
                    </div>
                </div>

                <!-- العنوان -->
                <div class="bg-green-50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-green-800 mb-4">🏠 العنوان</h3>
                    <div class="flex gap-4 mb-4">
                        <button type="button" onclick="selectAddressType('house')" id="houseBtn" class="flex-1 py-3 px-6 border-2 border-green-300 rounded-lg font-medium transition-all duration-200 hover:bg-green-100">🏠 بيت</button>
                        <button type="button" onclick="selectAddressType('apartment')" id="apartmentBtn" class="flex-1 py-3 px-6 border-2 border-gray-300 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100">🏢 شقة</button>
                    </div>

                    <div id="addressFields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- سيتم إضافة حقول العنوان هنا -->
                    </div>
                </div>

                <!-- نوع الاشتراك -->
                <div class="bg-purple-50 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-purple-800 mb-4">📋 نوع الاشتراك</h3>
                    <div class="grid grid-cols-1 gap-4 max-h-96 overflow-y-auto">
                        <div id="subscriptionTypes"></div>
                    </div>
                </div>

                <!-- تفاصيل الاشتراك -->
                <div id="subscriptionDetails" class="bg-orange-50 rounded-xl p-6 hidden">
                    <h3 class="text-xl font-semibold text-orange-800 mb-4">⏰ تفاصيل الاشتراك</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">تاريخ بدء الاشتراك *</label>
                            <input type="date" id="startDate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="calculateEndDate()">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">وقت التوصيل *</label>
                            <select id="deliveryTime" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="">اختر وقت التوصيل</option>
                                <option value="9-12">من ٩ص الى ١٢ظ</option>
                                <option value="12-15">من ١٢ظ الى ٣م</option>
                                <option value="15-18">من ٣م الى ٦م</option>
                                <option value="18-21">من ٦م الى ٩م</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">الأيام المستبعدة من التوصيل</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2" id="weekDays">
                            <!-- سيتم إضافة أيام الأسبوع هنا -->
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">سعر التوصيل (د.ك)</label>
                            <input type="number" id="deliveryPrice" step="0.1" min="0" value="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="updateTotalPrice()">
                            <div id="freeDeliveryNote" class="text-sm text-green-600 mt-1 hidden">✅ التوصيل مجاني</div>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-2">ملخص الأسعار:</div>
                            <div class="space-y-1">
                                <div class="flex justify-between"><span>سعر الاشتراك:</span><span id="subscriptionPriceDisplay">0 د.ك</span></div>
                                <div class="flex justify-between"><span>سعر التوصيل:</span><span id="deliveryPriceDisplay">0 د.ك</span></div>
                                <div class="flex justify-between font-bold border-t pt-1"><span>الإجمالي:</span><span id="totalPriceDisplay">0 د.ك</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-blue-100 rounded-lg" id="datesSummary" style="display: none;">
                        <!-- سيتم عرض ملخص التواريخ هنا -->
                    </div>
                </div>



                <!-- أزرار الإجراءات -->
                <div class="flex gap-4 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeModal('newSubscriptionModal')" class="flex-1 py-3 px-6 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 hover:border-gray-400 transition-all duration-200">❌ إلغاء</button>
                    <button type="submit" id="submitBtn" class="flex-1 py-3 px-6 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-lg hover:shadow-xl">✅ إنشاء الاستمارة</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة التأكيد -->
    <div id="confirmationModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full m-4 p-8 text-center" onclick="event.stopPropagation()">
            <div class="text-6xl mb-4">🎉</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">شكراً لثقتكم</h2>
            <p class="text-gray-600 mb-6">تم اعتماد الاشتراك، يرجى المتابعة مع الموظف للدفع</p>
            <button onclick="closeModal('confirmationModal')" class="w-full py-3 px-6 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-300">
                حسناً
            </button>
        </div>
    </div>

    <!-- نافذة عرض الصورة -->
    <div id="imageModal" class="modal">
        <div class="relative" onclick="event.stopPropagation()">
            <img id="modalImage" src="" alt="صورة الاشتراك" class="rounded-lg shadow-2xl max-w-[90vw] max-h-[90vh] object-contain">
            <button type="button" onclick="closeModal('imageModal')" class="absolute top-4 right-4 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl transition-all">✕</button>
        </div>
    </div>



    <!-- منطقة الطباعة المخفية -->
    <div id="printArea" class="print-content hidden">
        <!-- سيتم إنشاء محتوى الطباعة هنا -->
    </div>

    <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBIP8ezD990c7kZ3z-gsma2KJpp7Zqu7eA",
            authDomain: "ishtrakta.firebaseapp.com",
            databaseURL: "https://ishtrakta-default-rtdb.firebaseio.com",
            projectId: "ishtrakta",
            storageBucket: "ishtrakta.firebasestorage.app",
            messagingSenderId: "854766859254",
            appId: "1:854766859254:web:0375c2c8c9c518b2f74dd7",
            measurementId: "G-QT71DGNRXT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // بيانات الاشتراكات
        const subscriptionTypes = [
            { id: 1, name: "اشتراك إنقاص الوزن النباتي", prices: { week: 87.5, twoWeeks: 120, month: 240 }, image: "a1.jpg" },
            { id: 2, name: "اشتراك إنقاص الوزن", prices: { week: 93.5, twoWeeks: 130, month: 250 }, image: "a2.jpg" },
            { id: 3, name: "اشتراك خاص لرفع المناعة", prices: { week: 95, twoWeeks: 145, month: 280 }, image: "a3.jpg" },
            { id: 4, name: "اشتراك نظام الكيتو", prices: { week: 95, twoWeeks: 140, month: 280 }, image: "a4.jpg" },
            { id: 5, name: "اشتراك خالي من الجلوتين", prices: { week: 93.5, twoWeeks: 130, month: 260 }, image: "a5.jpg" },
            { id: 6, name: "اشتراك خالي من الجلوتين ومنتجات الألبان", prices: { week: 91.5, twoWeeks: 128.5, month: 255 }, image: "a6.jpg" },
            { id: 7, name: "اشتراك التخلص من الالتهابات في الجسم بالصيام المتقطع", prices: { tenDays: 120, twentyDays: 200, thirtyDays: 290 }, image: "a7.jpg", note: "مع اشتراك التلقرام الذي قيمته ٥٠ دينار مجاناً لاشتراك الشهر فقط" },
            { id: 8, name: "اشتراك التخلص من الإلتهابات بدون صيام", prices: { tenDays: 130, twentyDays: 210, thirtyDays: 300 }, image: "a8.jpg", note: "مع اشتراك التلقرام الذي قيمته ٥٠ دينار مجاناً لاشتراك الشهر فقط" },
            { id: 9, name: "اشتراك رمضان", prices: { week: 90, twoWeeks: 140, month: 240 }, image: "a9.jpg" },
            { id: 10, name: "اشتراك رمضان النباتي", prices: { week: 80, twoWeeks: 130, month: 230 }, image: "a10.jpg" },
            { id: 11, name: "اشتراك رفع نسب امتصاص الفيتامينت، والمعادن (يصلح للنساء الحامل)", prices: { week: 93.5, twoWeeks: 130, month: 250 }, image: "a11.jpg" },
            { id: 12, name: "اشتراك خاص للنساء المرضعات", prices: { week: 93.5, twoWeeks: 130, month: 260 }, image: "a12.jpg" },
            { id: 13, name: "اشتراك ضد أنواع الحساسيات الشائعة", prices: { week: 96.5, twoWeeks: 133.5, month: 260 }, image: "a13.jpg" },
            { id: 14, name: "اشتراك خاص للرياضيين", prices: { tenDays: 120, twentyDays: 180, thirtyDays: 230 }, image: "a14.jpg" },
            { id: 15, name: "اسلوب الحياة الصحية (غير مخصص لخسارة الوزن)", prices: { tenDays: 120, twentyDays: 180, thirtyDays: 230 }, image: "a15.jpg" },
            { id: 16, name: "اشتراك الأخصائية ريم العنزي، محسوب السعرات", prices: { tenDays: 150, twentyDays: 200, thirtyDays: 230 }, image: "a16.jpg" },
            { id: 17, name: "اشتراك ريوق المستشفى", prices: { week: 50, twoWeeks: 80, month: 120 }, image: "a17.jpg" },
            { id: 18, name: "اشتراك مخصص", prices: { custom: true }, image: null, isCustom: true }
        ];

        let selectedSubscription = null;
        let selectedPeriod = null;
        let selectedPrice = 0;
        let addressType = null;
        let excludedDays = [];
        let signaturePad = null;
        let isSignatureSigned = false;
        let currentSubscriptionData = null;

        // تحويل الأرقام العربية إلى إنجليزية
        function convertArabicToEnglish(input) {
            const arabicNumbers = '٠١٢٣٤٥٦٧٨٩';
            const englishNumbers = '0123456789';
            let value = input.value;
            
            for (let i = 0; i < arabicNumbers.length; i++) {
                value = value.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
            }
            
            input.value = value;
        }

        // فتح النافذة
        function openModal(modalId) {
            // إغلاق جميع النوافذ أولاً
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
            
            // فتح النافذة المطلوبة
            setTimeout(() => {
                document.getElementById(modalId).classList.add('show');
            }, 100);
        }

        // إغلاق النافذة
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            
            if (modalId === 'newSubscriptionModal') {
                resetForm();
            }
        }

        // فتح نموذج الاشتراك الجديد
        function openNewSubscriptionForm() {
            openModal('newSubscriptionModal');
            initializeSubscriptionTypes();
            initializeWeekDays();
        }

        // إعادة تعيين النموذج
        function resetForm() {
            selectedSubscription = null;
            selectedPeriod = null;
            selectedPrice = 0;
            addressType = null;
            excludedDays = [];
            
            document.getElementById('subscriptionForm').reset();
            document.getElementById('subscriptionDetails').classList.add('hidden');
            document.getElementById('addressFields').innerHTML = '';
        }

        // اختيار نوع العنوان
        function selectAddressType(type) {
            addressType = type;
            document.getElementById('houseBtn').className = type === 'house' ? 
                'flex-1 py-3 px-6 border-2 border-green-500 bg-green-100 rounded-lg font-medium transition-all duration-200' :
                'flex-1 py-3 px-6 border-2 border-gray-300 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100';
            
            document.getElementById('apartmentBtn').className = type === 'apartment' ? 
                'flex-1 py-3 px-6 border-2 border-green-500 bg-green-100 rounded-lg font-medium transition-all duration-200' :
                'flex-1 py-3 px-6 border-2 border-gray-300 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100';
            
            generateAddressFields(type);
        }

        // إنشاء حقول العنوان
        function generateAddressFields(type) {
            const addressFields = document.getElementById('addressFields');
            
            if (type === 'house') {
                addressFields.innerHTML = `
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">المنطقة *</label><input type="text" id="area" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">القطعة *</label><input type="text" id="block" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الشارع *</label><input type="text" id="street" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الجادة (إن وجدت)</label><input type="text" id="avenue" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">رقم المنزل *</label><input type="text" id="houseNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">مبنى مجاور؟ (اختياري)</label><input type="text" id="nearbyBuilding" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                `;
            } else if (type === 'apartment') {
                addressFields.innerHTML = `
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">المنطقة *</label><input type="text" id="area" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">القطعة *</label><input type="text" id="block" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الشارع *</label><input type="text" id="street" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الجادة (إن وجدت)</label><input type="text" id="avenue" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">رقم/اسم البناية *</label><input type="text" id="buildingName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الطابق *</label><input type="text" id="floor" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">الشقة *</label><input type="text" id="apartment" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">مبنى مجاور؟ (اختياري)</label><input type="text" id="nearbyBuilding" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></div>
                `;
            }
        }

        // تهيئة أنواع الاشتراكات
        function initializeSubscriptionTypes() {
            const container = document.getElementById('subscriptionTypes');
            container.innerHTML = '';
            
            subscriptionTypes.forEach(subscription => {
                const div = document.createElement('div');
                div.className = 'subscription-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all duration-200 hover:shadow-lg';
                div.onclick = () => selectSubscription(subscription);
                
                let pricesHtml = '';
                if (subscription.isCustom) {
                    pricesHtml = '<div class="text-sm text-gray-600">سعر مخصص</div>';
                } else {
                    const prices = subscription.prices;
                    if (prices.week) {
                        pricesHtml += `<div class="text-sm text-gray-600">أسبوع: ${prices.week} د.ك | أسبوعين: ${prices.twoWeeks} د.ك | شهر: ${prices.month} د.ك</div>`;
                    } else {
                        pricesHtml += `<div class="text-sm text-gray-600">١٠ أيام: ${prices.tenDays} د.ك | ٢٠ يوم: ${prices.twentyDays} د.ك | ٣٠ يوم: ${prices.thirtyDays} د.ك</div>`;
                    }
                }
                
                div.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-2">${subscription.name}</h4>
                            ${pricesHtml}
                            ${subscription.note ? `<div class="text-xs text-blue-600 mt-1">${subscription.note}</div>` : ''}
                        </div>
                        ${subscription.image ? `<img src="${subscription.image}" alt="صورة الاشتراك" class="subscription-image w-16 h-16 object-cover rounded-lg" onclick="event.stopPropagation(); showImage('${subscription.image}')">` : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // اختيار الاشتراك
        function selectSubscription(subscription) {
            selectedSubscription = subscription;
            
            // تحديث التصميم
            document.querySelectorAll('.subscription-card').forEach(card => {
                card.className = 'subscription-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all duration-200 hover:shadow-lg';
            });
            event.currentTarget.className = 'subscription-card border-2 border-purple-500 bg-purple-50 rounded-xl p-4 cursor-pointer transition-all duration-200 shadow-lg';
            
            // عرض خيارات الفترة
            showPeriodOptions(subscription);
        }

        // عرض خيارات الفترة
        function showPeriodOptions(subscription) {
            const detailsDiv = document.getElementById('subscriptionDetails');
            detailsDiv.classList.remove('hidden');
            
            // البحث عن div خيارات الفترة الموجود أو إنشاء واحد جديد
            let periodContainer = detailsDiv.querySelector('.period-options-container');
            if (!periodContainer) {
                periodContainer = document.createElement('div');
                periodContainer.className = 'period-options-container';
                const firstChild = detailsDiv.querySelector('h3').nextElementSibling;
                firstChild.insertBefore(periodContainer, firstChild.firstChild);
            }
            
            // إنشاء خيارات الفترة
            let periodOptionsHtml = '<div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-3">اختر فترة الاشتراك *</label><div class="grid grid-cols-1 md:grid-cols-3 gap-3">';
            
            if (subscription.isCustom) {
                periodOptionsHtml += `
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('week', 0)">
                        <div class="font-semibold">أسبوع</div>
                        <div class="text-sm text-gray-600">سعر مخصص</div>
                    </div>
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('twoWeeks', 0)">
                        <div class="font-semibold">أسبوعين</div>
                        <div class="text-sm text-gray-600">سعر مخصص</div>
                    </div>
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('fourWeeks', 0)">
                        <div class="font-semibold">٤ أسابيع</div>
                        <div class="text-sm text-gray-600">سعر مخصص</div>
                    </div>
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('tenDays', 0)">
                        <div class="font-semibold">١٠ أيام</div>
                        <div class="text-sm text-gray-600">سعر مخصص</div>
                    </div>
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('twentyDays', 0)">
                        <div class="font-semibold">٢٠ يوم</div>
                        <div class="text-sm text-gray-600">سعر مخصص</div>
                    </div>
                    <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('thirtyDays', 0)">
                        <div class="font-semibold">٣٠ يوم</div>
                        <div class="text-sm text-gray-600">سعر مخصص</div>
                    </div>
                `;
                periodOptionsHtml += '</div></div>';
                
                // إضافة حقول الاشتراك المخصص
                periodOptionsHtml += `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">السعر المخصص (د.ك) *</label>
                        <input type="number" id="customPrice" step="0.1" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="updateCustomPrice()">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">صورة جدول الاشتراك *</label>
                        <input type="file" id="customImage" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="previewCustomImage()">
                        <div id="imagePreview" class="mt-2"></div>
                    </div>
                `;
            } else {
                const prices = subscription.prices;
                if (prices.week) {
                    periodOptionsHtml += `
                        <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('week', ${prices.week})">
                            <div class="font-semibold">أسبوع</div>
                            <div class="text-sm text-gray-600">${prices.week} د.ك</div>
                        </div>
                        <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('twoWeeks', ${prices.twoWeeks})">
                            <div class="font-semibold">أسبوعين</div>
                            <div class="text-sm text-gray-600">${prices.twoWeeks} د.ك</div>
                        </div>
                        <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('month', ${prices.month})">
                            <div class="font-semibold">شهر</div>
                            <div class="text-sm text-gray-600">${prices.month} د.ك</div>
                        </div>
                    `;
                } else {
                    periodOptionsHtml += `
                        <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('tenDays', ${prices.tenDays})">
                            <div class="font-semibold">١٠ أيام</div>
                            <div class="text-sm text-gray-600">${prices.tenDays} د.ك</div>
                        </div>
                        <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('twentyDays', ${prices.twentyDays})">
                            <div class="font-semibold">٢٠ يوم</div>
                            <div class="text-sm text-gray-600">${prices.twentyDays} د.ك</div>
                        </div>
                        <div class="price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center" onclick="selectPeriod('thirtyDays', ${prices.thirtyDays})">
                            <div class="font-semibold">٣٠ يوم</div>
                            <div class="text-sm text-gray-600">${prices.thirtyDays} د.ك</div>
                        </div>
                    `;
                }
                periodOptionsHtml += '</div></div>';
            }
            
            // تحديث محتوى الحاوية
            periodContainer.innerHTML = periodOptionsHtml;
        }

        // اختيار الفترة
        function selectPeriod(period, price) {
            selectedPeriod = period;
            selectedPrice = price;
            
            // تحديث التصميم
            document.querySelectorAll('.price-option').forEach(option => {
                option.className = 'price-option border-2 border-gray-300 rounded-lg p-3 cursor-pointer text-center';
            });
            event.currentTarget.className = 'price-option border-2 border-orange-500 bg-orange-50 rounded-lg p-3 cursor-pointer text-center';
            
            updateTotalPrice();
        }

        // تحديث السعر المخصص
        function updateCustomPrice() {
            const customPrice = parseFloat(document.getElementById('customPrice').value) || 0;
            selectedPrice = customPrice;
            updateTotalPrice();
        }

        // معاينة الصورة المخصصة
        function previewCustomImage() {
            const file = document.getElementById('customImage').files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="معاينة الصورة" class="image-preview rounded-lg border">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // تهيئة أيام الأسبوع
        function initializeWeekDays() {
            const weekDays = ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];
            const container = document.getElementById('weekDays');
            container.innerHTML = '';
            
            weekDays.forEach((day, index) => {
                const div = document.createElement('div');
                div.className = 'day-checkbox flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer';
                div.onclick = () => toggleDay(index, div);
                div.innerHTML = `
                    <input type="checkbox" id="day${index}" checked class="mr-2">
                    <label for="day${index}" class="text-sm cursor-pointer">${day}</label>
                `;
                container.appendChild(div);
            });
        }

        // تبديل اليوم
        function toggleDay(dayIndex, element) {
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                excludedDays = excludedDays.filter(day => day !== dayIndex);
                element.className = 'day-checkbox flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer';
            } else {
                excludedDays.push(dayIndex);
                element.className = 'day-checkbox flex items-center p-2 border border-red-300 bg-red-50 rounded-lg cursor-pointer';
            }
            
            calculateEndDate();
        }

        // حساب تاريخ الانتهاء
        function calculateEndDate() {
            const startDateInput = document.getElementById('startDate');
            if (!startDateInput.value || !selectedPeriod) return;
            
            const startDate = new Date(startDateInput.value);
            let duration = 0;
            
            switch (selectedPeriod) {
                case 'week': duration = 7; break;
                case 'twoWeeks': duration = 14; break;
                case 'fourWeeks': duration = 28; break;
                case 'tenDays': duration = 10; break;
                case 'twentyDays': duration = 20; break;
                case 'thirtyDays': duration = 30; break;
                case 'month': duration = 28; break;
                case 'custom': 
                    const customDuration = prompt('كم يوم مدة الاشتراك المخصص؟');
                    duration = parseInt(customDuration) || 0; 
                    break;
            }
            
            if (duration === 0) return;
            
            let currentDate = new Date(startDate);
            let deliveryDays = 0;
            
            while (deliveryDays < duration) {
                if (!excludedDays.includes(currentDate.getDay())) {
                    deliveryDays++;
                }
                if (deliveryDays < duration) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            const endDate = currentDate;
            
            // عرض ملخص التواريخ بالميلادي العربي
            const summary = document.getElementById('datesSummary');
            summary.style.display = 'block';
            summary.innerHTML = `
                <div class="font-semibold text-blue-800 mb-2">📅 ملخص التواريخ:</div>
                <div class="space-y-1 text-sm">
                    <div><strong>تاريخ البدء:</strong> ${startDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' })}</div>
                    <div><strong>تاريخ الانتهاء:</strong> ${endDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' })}</div>
                    <div><strong>عدد أيام التوصيل:</strong> ${duration} يوم</div>
                    ${excludedDays.length > 0 ? `<div><strong>الأيام المستبعدة:</strong> ${excludedDays.map(day => ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'][day]).join(', ')}</div>` : ''}
                </div>
            `;
        }

        // تحديث السعر الإجمالي
        function updateTotalPrice() {
            const deliveryPrice = parseFloat(document.getElementById('deliveryPrice').value) || 0;
            const totalPrice = selectedPrice + deliveryPrice;
            
            document.getElementById('subscriptionPriceDisplay').textContent = selectedPrice + ' د.ك';
            document.getElementById('deliveryPriceDisplay').textContent = deliveryPrice + ' د.ك';
            document.getElementById('totalPriceDisplay').textContent = totalPrice + ' د.ك';
            
            // إظهار ملاحظة التوصيل المجاني
            const freeDeliveryNote = document.getElementById('freeDeliveryNote');
            if (deliveryPrice === 0) {
                freeDeliveryNote.classList.remove('hidden');
            } else {
                freeDeliveryNote.classList.add('hidden');
            }
        }



        // عرض الصورة
        function showImage(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            openModal('imageModal');
        }

        // إرسال النموذج
        document.getElementById('subscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedSubscription || !selectedPeriod || !addressType) {
                alert('يرجى إكمال جميع البيانات المطلوبة');
                return;
            }
            
            // جمع البيانات
            const formData = {
                customerName: document.getElementById('customerName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                addressType: addressType,
                address: getAddressData(),
                subscription: selectedSubscription,
                period: selectedPeriod,
                price: selectedPrice,
                startDate: document.getElementById('startDate').value,
                deliveryTime: document.getElementById('deliveryTime').value,
                excludedDays: excludedDays,
                deliveryPrice: parseFloat(document.getElementById('deliveryPrice').value) || 0,
                totalPrice: selectedPrice + (parseFloat(document.getElementById('deliveryPrice').value) || 0),
                createdAt: new Date(),
                status: 'pending'
            };
            
            try {
                // حفظ في Firebase
                const docRef = await db.collection('subscriptions').add(formData);
                
                // إنشاء رابط العميل - رابط كامل للواتساب
                const customerLink = `https://figsandolives.github.io/ishtrak/sign.html?customer=${docRef.id}`;
                
                // إنشاء رسالة الواتساب
                const whatsappMessage = `تم تعبئة بيانات استمارة الاشتراك بنجاح،
يرجى الضغط على الرابط التالي للاعتماد والتوقيع:
${customerLink}`;
                
                // تنظيف رقم الهاتف وإنشاء رابط الواتساب
                const cleanPhone = formData.phoneNumber.replace(/[^\d]/g, '');
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(whatsappMessage)}`;
                
                // إغلاق النموذج
                closeModal('newSubscriptionModal');
                
                // فتح الواتساب في نافذة جديدة
                window.open(whatsappUrl, '_blank');
                
                // إظهار رسالة النجاح
                alert('تم إنشاء الاستمارة بنجاح! تم فتح الواتساب لإرسال الرابط للعميل.');
                
                // تحديث قائمة الاستمارات
                loadSubscriptions();
                
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                alert('حدث خطأ في إنشاء الاستمارة. يرجى المحاولة مرة أخرى.');
            }
        });



        // تحويل Data URL إلى Blob
        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        // الحصول على بيانات العنوان
        function getAddressData() {
            const address = {
                area: document.getElementById('area').value,
                block: document.getElementById('block').value,
                street: document.getElementById('street').value,
                avenue: document.getElementById('avenue')?.value || '',
                nearbyBuilding: document.getElementById('nearbyBuilding')?.value || ''
            };
            
            if (addressType === 'house') {
                address.houseNumber = document.getElementById('houseNumber').value;
            } else {
                address.buildingName = document.getElementById('buildingName').value;
                address.floor = document.getElementById('floor').value;
                address.apartment = document.getElementById('apartment').value;
            }
            
            return address;
        }

        // تحميل الاستمارات المحفوظة
        async function loadSubscriptions() {
            try {
                const snapshot = await db.collection('subscriptions').orderBy('createdAt', 'desc').get();
                const subscriptionsList = document.getElementById('subscriptionsList');
                
                if (snapshot.empty) {
                    subscriptionsList.innerHTML = `
                        <div class="text-center py-12 col-span-full">
                            <div class="text-6xl mb-4">📋</div>
                            <p class="text-gray-500 text-lg">لا توجد استمارات معتمدة حتى الآن</p>
                        </div>
                    `;
                    return;
                }
                
                subscriptionsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow';
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-semibold text-lg text-gray-800">${data.customerName}</h3>
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${data.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${data.status === 'approved' ? 'معتمد' : 'في الانتظار'}</span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                            <div><strong>الهاتف:</strong> ${data.phoneNumber}</div>
                            <div><strong>الاشتراك:</strong> ${data.subscription.name}</div>
                            <div><strong>المدة:</strong> ${getPeriodText(data.period)}</div>
                            <div><strong>السعر:</strong> ${data.totalPrice} د.ك</div>
                            <div><strong>تاريخ البدء:</strong> ${new Date(data.startDate).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' })}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="sendToCustomer('${doc.id}')" class="flex-1 py-2 px-4 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">📤 إرسال للعميل</button>
                            <button onclick="editSubscription('${doc.id}')" class="flex-1 py-2 px-4 bg-yellow-500 text-white rounded-lg text-sm hover:bg-yellow-600 transition-colors">✏️ تعديل</button>
                            <button onclick="deleteSubscription('${doc.id}')" class="flex-1 py-2 px-4 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-colors">🗑️ حذف</button>
                            ${data.status === 'approved' ? `<button onclick="printSubscription('${doc.id}')" class="py-2 px-4 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-colors">🖨️ طباعة</button>` : ''}
                        </div>
                    `;
                    subscriptionsList.appendChild(div);
                });
                
            } catch (error) {
                console.error('خطأ في تحميل الاستمارات:', error);
            }
        }

        // إرسال للعميل - رابط كامل
        function sendToCustomer(id) {
            const customerLink = `https://figsandolives.github.io/ishtrak/sign.html?customer=${id}`;
            
            // نسخ الرابط إلى الحافظة
            navigator.clipboard.writeText(customerLink).then(() => {
                alert(`تم نسخ رابط العميل إلى الحافظة:\n${customerLink}\n\nيمكنك إرسال هذا الرابط للعميل للتوقيع والاعتماد.`);
            }).catch(() => {
                alert(`رابط العميل:\n${customerLink}\n\nيرجى نسخ هذا الرابط وإرساله للعميل للتوقيع والاعتماد.`);
            });
        }

        // تعديل الاشتراك
        function editSubscription(id) {
            // يمكن تطوير هذه الوظيفة لاحقاً
            alert('وظيفة التعديل قيد التطوير');
        }

        // حذف الاشتراك
        async function deleteSubscription(id) {
            if (confirm('هل أنت متأكد من حذف هذا الاشتراك؟')) {
                try {
                    await db.collection('subscriptions').doc(id).delete();
                    loadSubscriptions();
                    alert('تم حذف الاشتراك بنجاح');
                } catch (error) {
                    console.error('خطأ في حذف الاشتراك:', error);
                    alert('حدث خطأ في حذف الاشتراك');
                }
            }
        }

        // طباعة الاشتراك
        async function printSubscription(id) {
            try {
                const doc = await db.collection('subscriptions').doc(id).get();
                if (!doc.exists) {
                    alert('الاشتراك غير موجود');
                    return;
                }
                
                const data = doc.data();
                generatePrintContent(data);
                
                // طباعة الصفحة
                setTimeout(() => {
                    window.print();
                }, 500);
                
            } catch (error) {
                console.error('خطأ في طباعة الاشتراك:', error);
                alert('حدث خطأ في طباعة الاشتراك');
            }
        }

        // إنشاء محتوى الطباعة
        function generatePrintContent(data) {
            const printArea = document.getElementById('printArea');
            const subscriptionNumber = Math.floor(Math.random() * 10000) + 1000;
            
            // تحديد عدد نسخ جدول الاشتراك
            let copies = 1;
            if (data.period === 'twoWeeks' || data.period === 'twentyDays') {
                copies = 2;
            } else if (data.period === 'month' || data.period === 'thirtyDays' || data.period === 'fourWeeks') {
                copies = 3;
            }
            
            let printHTML = `
                <!-- صفحة الاستمارة -->
                <div class="print-page">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold mb-2">استمارة اشتراك</h1>
                        <p class="text-lg text-gray-600">رقم الاستمارة: ${subscriptionNumber}</p>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- بيانات العميل -->
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="text-xl font-semibold mb-4 text-blue-800">بيانات العميل</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><strong>اسم الزبون:</strong> ${data.customerName}</div>
                                <div><strong>رقم الهاتف:</strong> ${data.phoneNumber}</div>
                            </div>
                        </div>
                        
                        <!-- العنوان -->
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="text-xl font-semibold mb-4 text-green-800">العنوان</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><strong>النوع:</strong> ${data.addressType === 'house' ? 'بيت' : 'شقة'}</div>
                                <div><strong>المنطقة:</strong> ${data.address.area}</div>
                                <div><strong>القطعة:</strong> ${data.address.block}</div>
                                <div><strong>الشارع:</strong> ${data.address.street}</div>
                                ${data.address.avenue ? `<div><strong>الجادة:</strong> ${data.address.avenue}</div>` : ''}
                                ${data.addressType === 'house' ? 
                                    `<div><strong>رقم المنزل:</strong> ${data.address.houseNumber}</div>` :
                                    `<div><strong>البناية:</strong> ${data.address.buildingName}</div>
                                     <div><strong>الطابق:</strong> ${data.address.floor}</div>
                                     <div><strong>الشقة:</strong> ${data.address.apartment}</div>`
                                }
                                ${data.address.nearbyBuilding ? `<div><strong>مبنى مجاور:</strong> ${data.address.nearbyBuilding}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- تفاصيل الاشتراك -->
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="text-xl font-semibold mb-4 text-purple-800">تفاصيل الاشتراك</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><strong>نوع الاشتراك:</strong> ${data.subscription.name}</div>
                                <div><strong>المدة:</strong> ${getPeriodText(data.period)}</div>
                                <div><strong>تاريخ البدء:</strong> ${new Date(data.startDate).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' })}</div>
                                <div><strong>وقت التوصيل:</strong> ${data.deliveryTime}</div>
                                <div><strong>سعر الاشتراك:</strong> ${data.price} د.ك</div>
                                <div><strong>سعر التوصيل:</strong> ${data.deliveryPrice} د.ك</div>
                                <div><strong>الإجمالي:</strong> ${data.totalPrice} د.ك</div>
                                ${data.excludedDays.length > 0 ? `<div class="col-span-2"><strong>الأيام المستبعدة:</strong> ${data.excludedDays.map(day => ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'][day]).join(', ')}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- الشروط والأحكام -->
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="text-xl font-semibold mb-4 text-red-800">الشروط والأحكام</h3>
                            <div class="space-y-2 text-sm">
                                <div>• المبلغ المدفوع لا يسترد.</div>
                                <div>• إذا تم إلغاء الاشتراك لأي سبب كان من طرف العميل يتم حساب المبلغ المتبقي من الاشتراك ويصبح كوبون مشتريات للعميل يمكنه الشراء به من مخبز التين والزيتون أو مطعم التين الطبيعي في أي وقت.</div>
                            </div>
                        </div>
                        
                        <!-- التوقيع -->
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="text-xl font-semibold mb-4">توقيع العميل</h3>
                            ${data.signatureURL ? `<img src="${data.signatureURL}" alt="توقيع العميل" class="border border-gray-300 rounded max-h-32">` : '<div class="border border-gray-300 rounded h-32 flex items-center justify-center text-gray-500">لا يوجد توقيع</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            // إضافة نسخ جدول الاشتراك
            for (let i = 0; i < copies; i++) {
                if (data.subscription.image) {
                    printHTML += `
                        <div class="print-page">
                            <div class="text-center mb-4">
                                <h2 class="text-2xl font-bold">جدول الاشتراك - نسخة ${i + 1}</h2>
                            </div>
                            <div class="flex justify-center">
                                <img src="${data.subscription.image}" alt="جدول الاشتراك" class="max-w-full max-h-full object-contain">
                            </div>
                        </div>
                    `;
                }
            }
            
            printArea.innerHTML = printHTML;
            printArea.classList.remove('hidden');
        }

        // الحصول على نص الفترة
        function getPeriodText(period) {
            const periods = {
                'week': 'أسبوع',
                'twoWeeks': 'أسبوعين',
                'fourWeeks': '٤ أسابيع',
                'month': 'شهر',
                'tenDays': '١٠ أيام',
                'twentyDays': '٢٠ يوم',
                'thirtyDays': '٣٠ يوم',
                'custom': 'مخصص'
            };
            return periods[period] || period;
        }

        // إغلاق النوافذ بمفتاح الهروب
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const activeModal = document.querySelector('.modal.show');
                if (activeModal) {
                    closeModal(activeModal.id);
                }
            }
        });

        // إغلاق النوافذ بالضغط على الخلفية
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal') && event.target.classList.contains('show')) {
                closeModal(event.target.id);
            }
        });


        
        // تحميل الاستمارات عند تحميل الصفحة
        window.addEventListener('load', loadSubscriptions);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96b7193530b87cd5',t:'MTc1NDU3MzExMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
