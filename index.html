<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الاشتراكات</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SignaturePad library (loaded globally before module script) -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!-- UUID library (loaded globally before module script) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <!-- Firebase SDKs and main application logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : `{
            "apiKey": "AIzaSyBIP8ezD990c7kZ3z-gsma2KJpp7Zqu7eA",
            "authDomain": "ishtrakta.firebaseapp.com",
            "databaseURL": "https://ishtrakta-default-rtdb.firebaseio.com",
            "projectId": "ishtrakta",
            "storageBucket": "ishtrakta.firebasestorage.app",
            "messagingSenderId": "854766859254",
            "appId": "1:854766859254:web:0375c2c8c9c518b2f74dd7",
            "measurementId": "G-QT71DGNRXT"
        }`);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null; // Will store the authenticated user's ID

        // Function to sign in the user (employee)
        async function signInUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                currentUserId = auth.currentUser.uid;
                console.log("Firebase signed in. User ID:", currentUserId);
                renderView(); // Render the appropriate view after successful sign-in
            } catch (error) {
                console.error("Error signing in to Firebase:", error);
                // Fallback for local development if auth token is not available
                currentUserId = "local-dev-user"; 
                renderView();
            }
        }

        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Auth state changed. User ID:", currentUserId);
                renderView(); // Render the view based on current hash
            } else {
                currentUserId = null;
                console.log("User signed out or not authenticated.");
                signInUser(); // Attempt to sign in if not already
            }
        });

        // --- Global State and View Management ---
        let currentView = 'dashboard'; // 'dashboard', 'create-form', 'customer-signature'
        let currentFormId = null; // For customer signature page or editing

        // Function to render the correct view based on URL hash
        function renderView() {
            const hash = window.location.hash;
            console.log("renderView called. Current hash:", hash); // Added log for debugging
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            if (hash.startsWith('#customer-signature')) {
                currentView = 'customer-signature';
                const params = new URLSearchParams(hash.split('?')[1]);
                currentFormId = params.get('formId');
                showCustomerSignaturePage();
            } else if (hash === '#create-form') {
                currentView = 'create-form';
                showCreateFormPage();
            } else {
                currentView = 'dashboard';
                showDashboard();
            }
        }

        // Listen for hash changes to navigate between views
        window.addEventListener('hashchange', renderView);

        // --- Dashboard View Functions ---
        const dashboardView = document.getElementById('dashboardView');
        const createFormButton = document.getElementById('createFormButton');
        const formsList = document.getElementById('formsList');

        async function showDashboard() {
            if (!currentUserId) {
                console.log("User not authenticated for dashboard.");
                return;
            }
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            dashboardView.classList.remove('hidden');
            formsList.innerHTML = '<p class="text-center text-gray-500">جاري تحميل الاستمارات...</p>';

            // Ensure the button exists before attaching event listener (defensive programming)
            const createFormButtonElement = document.getElementById('createFormButton');
            if (createFormButtonElement && !createFormButtonElement._hasClickListener) { 
                createFormButtonElement.addEventListener('click', () => {
                    window.location.hash = '#create-form';
                });
                createFormButtonElement._hasClickListener = true; // Flag to prevent multiple listeners
            }

            try {
                // Fetch forms specific to the logged-in employee
                const formsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/subscriptionForms`);
                // Note: orderBy is removed as per instructions, sorting will be done client-side
                onSnapshot(formsRef, (snapshot) => {
                    formsList.innerHTML = '';
                    if (snapshot.empty) {
                        formsList.innerHTML = '<p class="text-center text-gray-500">لا توجد استمارات حالياً. اضغط "إنشاء استمارة جديدة" للبدء.</p>';
                        return;
                    }
                    const forms = [];
                    snapshot.forEach(doc => {
                        forms.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort by timestamp if available, otherwise by creation order
                    forms.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0)); 
                    forms.forEach(form => renderFormCard(form));
                });
            } catch (error) {
                console.error("Error fetching forms:", error);
                formsList.innerHTML = '<p class="text-center text-red-500">حدث خطأ أثناء تحميل الاستمارات.</p>';
            }
        }

        function renderFormCard(form) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col justify-between';
            const statusColor = form.status === 'signed' ? 'text-green-600' : 'text-orange-500';
            const statusText = form.status === 'signed' ? 'تم التوقيع' : 'بانتظار التوقيع';
            
            card.innerHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">استمارة رقم: ${form.formNumber || form.id.substring(0, 8)}</h3>
                    <p class="text-gray-700"><strong>العميل:</strong> ${form.customerName}</p>
                    <p class="text-gray-700"><strong>الهاتف:</strong> ${form.customerPhone}</p>
                    <p class="text-gray-700"><strong>نوع الاشتراك:</strong> ${form.subscription.name}</p>
                    <p class="text-gray-700 ${statusColor}"><strong>الحالة:</strong> ${statusText}</p>
                </div>
                <div class="mt-4 flex flex-wrap gap-2 justify-end">
                    <button class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition-colors" onclick="editForm('${form.id}')">تعديل</button>
                    <button class="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition-colors" onclick="deleteForm('${form.id}')">حذف</button>
                    <button class="bg-purple-500 text-white px-3 py-1 rounded-md text-sm hover:bg-purple-600 transition-colors" onclick="printForm('${form.id}')">طباعة</button>
                </div>
            `;
            formsList.appendChild(card);
        }

        async function editForm(formId) {
            console.log("Edit form:", formId);
            currentFormId = formId;
            window.location.hash = '#create-form'; // Reuse create form page for editing
            // The showCreateFormPage will load data if currentFormId is set
        }

        async function deleteForm(formId) {
            if (!confirm("هل أنت متأكد أنك تريد حذف هذه الاستمارة؟")) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/subscriptionForms`, formId));
                // Also delete from public collection if exists
                // Fix: Changed path to include 'data' collection
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/signedForms`, formId)).catch(e => console.log("Public form not found or already deleted:", e.message));
                console.log("Form deleted successfully:", formId);
            } catch (error) {
                console.error("Error deleting form:", error);
                alert("حدث خطأ أثناء حذف الاستمارة.");
            }
        }

        async function printForm(formId) {
            console.log("Print form:", formId);
            try {
                const employeeFormSnap = await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/subscriptionForms`, formId));
                // Fix: Changed path to include 'data' collection
                const publicFormSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/signedForms`, formId));

                if (!employeeFormSnap.exists()) {
                    alert("الاستمارة غير موجودة للطباعة.");
                    return;
                }

                const employeeData = employeeFormSnap.data();
                const publicData = publicFormSnap.exists() ? publicFormSnap.data() : {};

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>طباعة استمارة الاشتراك</title>
                        <style>
                            body { font-family: 'Inter', sans-serif; margin: 20mm; font-size: 12pt; line-height: 1.6; }
                            h1, h2 { text-align: center; margin-bottom: 10mm; }
                            .section { margin-bottom: 15mm; border-bottom: 1px dashed #ccc; padding-bottom: 10mm; }
                            .section:last-of-type { border-bottom: none; }
                            p { margin-bottom: 5mm; }
                            strong { font-weight: bold; }
                            .signature-box { border: 1px solid #000; padding: 10px; min-height: 100px; display: flex; align-items: center; justify-content: center; margin-top: 10mm; }
                            .signature-box img { max-width: 100%; max-height: 100px; object-fit: contain; }
                            .terms { font-size: 10pt; border: 1px solid #eee; padding: 10px; background-color: #f9f9f9; }
                            @media print {
                                body { margin: 0; padding: 10mm; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>استمارة اشتراك <br> رقم: ${employeeData.formNumber || employeeData.id.substring(0, 8)}</h1>
                        
                        <div class="section">
                            <h2>بيانات العميل</h2>
                            <p><strong>الاسم الكامل:</strong> ${employeeData.customerName}</p>
                            <p><strong>رقم الهاتف:</strong> ${employeeData.customerPhone}</p>
                        </div>

                        <div class="section">
                            <h2>معلومات العنوان</h2>
                            <p><strong>المنطقة:</strong> ${employeeData.address.area}</p>
                            <p><strong>القطعة:</strong> ${employeeData.address.block}</p>
                            <p><strong>الشارع:</strong> ${employeeData.address.street}</p>
                            ${employeeData.address.ave ? `<p><strong>الجادة:</strong> ${employeeData.address.ave}</p>` : ''}
                            ${employeeData.address.type === 'house' ? `<p><strong>رقم المنزل:</strong> ${employeeData.address.number}</p>` : ''}
                            ${employeeData.address.type === 'apartment' ? `
                                <p><strong>رقم/اسم البناية:</strong> ${employeeData.address.building}</p>
                                <p><strong>الطابق:</strong> ${employeeData.address.floor}</p>
                                <p><strong>الشقة:</strong> ${employeeData.address.apartment}</p>
                            ` : ''}
                            ${employeeData.address.neighbor ? `<p><strong>مبنى مجاور:</strong> ${employeeData.address.neighbor}</p>` : ''}
                        </div>

                        <div class="section">
                            <h2>تفاصيل الاشتراك</h2>
                            <p><strong>نوع الاشتراك:</strong> ${employeeData.subscription.name}</p>
                            <p><strong>المدة:</strong> ${employeeData.subscription.durationName} (${employeeData.subscription.durationInDays} يوم)</p>
                            <p><strong>السعر:</strong> ${employeeData.subscription.price} د.ك</p>
                            <p><strong>تاريخ البدء:</strong> ${employeeData.startDate}</p>
                            <p><strong>تاريخ الانتهاء:</strong> ${employeeData.endDate}</p>
                            <p><strong>أيام عدم التوصيل:</strong> ${employeeData.daysOff.length > 0 ? employeeData.daysOff.join(', ') : 'لا يوجد'}</p>
                            <p><strong>وقت التوصيل المناسب:</strong> ${employeeData.deliveryTime}</p>
                            ${employeeData.subscription.telegram ? `<p><strong>اشتراك تيليجرام مجاني:</strong> نعم</p>` : ''}
                            <p><strong>سعر التوصيل:</strong> ${employeeData.deliveryCost > 0 ? `${employeeData.deliveryCost} د.ك` : 'مجاني'}</p>
                            <p><strong>الإجمالي:</strong> ${employeeData.subscription.price + employeeData.deliveryCost} د.ك</p>
                        </div>

                        <div class="section terms">
                            <h2>الشروط والأحكام</h2>
                            <p>قد يكون هناك رسوم توصيل إضافية على سعر الاشتراك.</p>
                            <p>إذا تم إلغاء الاشتراك لأي سبب من طرف العميل، يتم حساب المبلغ المتبقي من الاشتراك ويصبح كوبون مشتريات للعميل يمكنه الشراء به من مخبز التين والزيتون أو مطعم التين الطبيعي في أي وقت.</p>
                        </div>

                        <div class="section">
                            <h2>توقيع العميل</h2>
                            <div class="signature-box">
                                ${publicData.signatureImage ? `<img src="${publicData.signatureImage}" alt="توقيع العميل">` : '<p>لم يتم التوقيع بعد</p>'}
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error("Error printing form:", error);
                alert("حدث خطأ أثناء طباعة الاستمارة.");
            }
        }

        // --- Create Form View Functions ---
        const createFormView = document.getElementById('createFormView');
        const createFormElement = document.getElementById('createFormElement');
        const phoneInput = document.getElementById('phone'); // Employee form phone
        const deliveryCostInput = document.getElementById('deliveryCost'); // Employee form delivery cost
        const houseFields = document.getElementById('houseFields');
        const apartmentFields = document.getElementById('apartmentFields');
        const addressTypeRadios = document.querySelectorAll('input[name="addressType"]');
        const startDateInput = document.getElementById('startDate');
        // Fix: Added missing closing square bracket for the attribute selector
        const deliveryDaysCheckboxes = document.querySelectorAll('input[name="deliveryDays"]');
        const subscriptionRadios = document.querySelectorAll('input[name="subscription"]');
        const subscriptionDatesSummary = document.getElementById('subscriptionDatesSummary');
        const createFormSubmitBtn = document.getElementById('createFormSubmitBtn');
        const customSubscriptionPriceDiv = document.getElementById('customSubscriptionPriceDiv');
        const customMealPlanImageUploadDiv = document.getElementById('customMealPlanImageUploadDiv');
        const customMealPlanImagePreview = document.getElementById('customMealPlanImagePreview');
        const customSubscriptionPriceInput = document.getElementById('customSubscriptionPrice');
        const customMealPlanImageUploadInput = document.getElementById('customMealPlanImageUpload');


        // Subscription data (same as previous version)
        const subscriptionsData = {
            '1': { name: 'اشتراك إنقاص الوزن النباتي', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '87.5', '14': '120', '28': '240' } },
            '2': { name: 'اشتراك إنقاص الوزن', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '93.5', '14': '130', '28': '250' } },
            '3': { name: 'اشتراك خاص لرفع المناعة', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '95', '14': '145', '28': '280' } },
            '4': { name: 'اشتراك نظام الكيتو', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '95', '14': '140', '28': '280' } },
            '5': { name: 'اشتراك خالي من الجلوتين', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '93.5', '14': '130', '28': '260' } },
            '6': { name: 'اشتراك خالي من الجلوتين ومنتجات الألبان', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '91.5', '14': '128.5', '28': '255' } },
            '7': { name: 'اشتراك التخلص من الالتهابات بالصيام المتقطع', durations: { '10': '10 أيام', '20': '20 يوم', '30': '30 يوم' }, prices: { '10': '120', '20': '200', '30': '290' }, telegram: true },
            '8': { name: 'اشتراك التخلص من الإلتهابات بدون صيام', durations: { '10': '10 أيام', '20': '20 يوم', '30': '30 يوم' }, prices: { '10': '130', '20': '210', '30': '300' }, telegram: true },
            '9': { name: 'اشتراك رمضان', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '90', '14': '140', '28': '240' } },
            '10': { name: 'اشتراك رمضان النباتي', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '80', '14': '130', '28': '230' } },
            '11': { name: 'اشتراك رفع نسب امتصاص الفيتامينات، والمعادن', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '93.5', '14': '130', '28': '250' } },
            '12': { name: 'اشتراك خاص للنساء المرضعات', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '93.5', '14': '130', '28': '260' } },
            '13': { name: 'اشتراك ضد أنواع الحساسيات الشائعة', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '96.5', '14': '133.5', '28': '260' } },
            '14': { name: 'اشتراك خاص للرياضيين', durations: { '10': '10 أيام', '20': '20 يوم', '30': '30 يوم' }, prices: { '10': '120', '20': '180', '30': '230' } },
            '15': { name: 'اسلوب الحياة الصحية', durations: { '10': '10 أيام', '20': '20 يوم', '30': '30 يوم' }, prices: { '10': '120', '20': '180', '30': '230' } },
            '16': { name: 'اشتراك الأخصائية ريم العنزي، محسوب السعرات', durations: { '10': '150', '20': '200', '30': '230' } },
            '17': { name: 'اشتراك ريوق المستشفى', durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع' }, prices: { '7': '50', '14': '80', '28': '120' } },
            'custom': { name: 'اشتراك مخصص', isCustom: true, durations: { '7': 'أسبوع', '14': '2 أسبوع', '28': '4 أسابيع', '30': '30 يوم' }, prices: {} }, // Custom subscription
        };

        async function showCreateFormPage() {
            console.log("showCreateFormPage called."); // Added log for debugging
            if (!currentUserId) {
                console.log("User not authenticated for creating form.");
                return;
            }
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            createFormView.classList.remove('hidden');
            createFormElement.reset(); // Clear form for new entry

            // Reset required attributes for address fields
            houseFields.querySelectorAll('input').forEach(input => input.removeAttribute('required'));
            apartmentFields.querySelectorAll('input').forEach(input => input.removeAttribute('required'));
            document.querySelector('input[name="addressType"][value="house"]').checked = true;
            // Manually trigger change to set initial required fields
            const event = new Event('change');
            document.querySelector('input[name="addressType"][value="house"]').dispatchEvent(event);

            // Hide all duration selects initially
            document.querySelectorAll('select[name^="duration_"]').forEach(select => select.style.display = 'none');
            
            // Hide custom fields initially
            customSubscriptionPriceDiv.classList.add('hidden');
            customSubscriptionPriceInput.removeAttribute('required');
            customMealPlanImageUploadDiv.classList.add('hidden');
            customMealPlanImageUploadInput.removeAttribute('required');
            customMealPlanImagePreview.src = '';
            customMealPlanImagePreview.classList.add('hidden');

            // Set first subscription radio button as checked and trigger change
            const firstSubscriptionRadio = document.querySelector('input[name="subscription"]');
            if (firstSubscriptionRadio) {
                firstSubscriptionRadio.checked = true;
                const changeEvent = new Event('change');
                firstSubscriptionRadio.dispatchEvent(changeEvent);
            }

            // Set first delivery time radio button as checked
            document.querySelector('input[name="deliveryTime"]').checked = true;

            // If editing, load existing data
            if (currentFormId) {
                try {
                    const formSnap = await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/subscriptionForms`, currentFormId));
                    if (formSnap.exists()) {
                        const data = formSnap.data();
                        document.getElementById('name').value = data.customerName;
                        document.getElementById('phone').value = data.customerPhone;
                        document.querySelector(`input[name="addressType"][value="${data.address.type}"]`).checked = true;
                        document.querySelector(`input[name="addressType"][value="${data.address.type}"]`).dispatchEvent(new Event('change')); // Trigger visibility
                        
                        // Populate address fields
                        if (data.address.type === 'house') {
                            document.getElementById('houseArea').value = data.address.area || '';
                            document.getElementById('houseBlock').value = data.address.block || '';
                            document.getElementById('houseStreet').value = data.address.street || '';
                            document.getElementById('houseAve').value = data.address.ave || '';
                            document.getElementById('houseNumber').value = data.address.number || '';
                            document.getElementById('houseNeighbor').value = data.address.neighbor || '';
                        } else { // apartment
                            document.getElementById('apartmentArea').value = data.address.area || '';
                            document.getElementById('apartmentBlock').value = data.address.block || '';
                            document.getElementById('apartmentStreet').value = data.address.street || '';
                            document.getElementById('apartmentAve').value = data.address.ave || '';
                            document.getElementById('buildingNumber').value = data.address.building || '';
                            document.getElementById('floorNumber').value = data.address.floor || '';
                            document.getElementById('apartmentNumber').value = data.address.apartment || '';
                            document.getElementById('apartmentNeighbor').value = data.address.neighbor || '';
                        }

                        document.querySelector(`input[name="subscription"][value="${data.subscription.id}"]`).checked = true;
                        document.querySelector(`input[name="subscription"][value="${data.subscription.id}"]`).dispatchEvent(new Event('change')); // Trigger duration select visibility

                        if (data.subscription.id === 'custom') {
                            customSubscriptionPriceInput.value = data.subscription.price;
                            if (data.subscription.customMealPlanImage) {
                                customMealPlanImagePreview.src = data.subscription.customMealPlanImage;
                                customMealPlanImagePreview.classList.remove('hidden');
                            }
                        } else {
                            document.querySelector(`select[name="duration_${data.subscription.id}"]`).value = `${data.subscription.durationInDays}_${data.subscription.price}`;
                        }
                        
                        document.getElementById('startDate').value = data.startDate;
                        data.daysOff.forEach(day => {
                            // Ensure the checkbox value matches the stored day index (0-6)
                            const dayIndex = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'].indexOf(day);
                            if (dayIndex !== -1) {
                                const checkbox = document.querySelector(`input[name="deliveryDays"][value="${dayIndex}"]`);
                                if (checkbox) checkbox.checked = false; // If it's a day off, it should be unchecked
                            }
                        });
                        document.querySelector(`input[name="deliveryTime"][value="${data.deliveryTime}"]`).checked = true;
                        document.getElementById('deliveryCost').value = data.deliveryCost;

                        calculateEndDate(); // Recalculate end date based on loaded data
                    } else {
                        console.error("Form not found for editing:", currentFormId);
                        currentFormId = null; // Reset if not found
                    }
                } catch (error) {
                    console.error("Error loading form for editing:", error);
                    currentFormId = null; // Reset on error
                }
            }
        }

        // Arabic to English number conversion for phone and delivery cost
        phoneInput.addEventListener('input', (e) => {
            const arabicToEnglish = s => s.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
            e.target.value = arabicToEnglish(e.target.value);
        });
        deliveryCostInput.addEventListener('input', (e) => {
            const arabicToEnglish = s => s.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
            e.target.value = arabicToEnglish(e.target.value);
        });
        customSubscriptionPriceInput.addEventListener('input', (e) => {
            const arabicToEnglish = s => s.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
            e.target.value = arabicToEnglish(e.target.value);
        });

        // Toggle address fields visibility and required attributes
        addressTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isHouse = e.target.value === 'house';
                houseFields.classList.toggle('hidden', !isHouse);
                apartmentFields.classList.toggle('hidden', isHouse);

                // Update required attributes for house fields
                houseFields.querySelectorAll('input').forEach(input => {
                    if (input.id === 'houseAve' || input.id === 'houseNeighbor') {
                        input.removeAttribute('required'); // Optional
                    } else {
                        isHouse ? input.setAttribute('required', '') : input.removeAttribute('required');
                    }
                });

                // Update required attributes for apartment fields
                apartmentFields.querySelectorAll('input').forEach(input => {
                    if (input.id === 'apartmentAve' || input.id === 'apartmentNeighbor') {
                        input.removeAttribute('required'); // Optional
                    } else {
                        !isHouse ? input.setAttribute('required', '') : input.removeAttribute('required');
                    }
                });
            });
        });

        // Handle custom meal plan image upload
        customMealPlanImageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    customMealPlanImagePreview.src = e.target.result;
                    customMealPlanImagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                customMealPlanImagePreview.src = '';
                customMealPlanImagePreview.classList.add('hidden');
            }
        });

        // Calculate end date logic (same as before)
        function calculateEndDate() {
            const startDate = startDateInput.value;
            const selectedSub = document.querySelector('input[name="subscription"]:checked');
            const selectedDurationSelect = selectedSub ? document.querySelector(`select[name="duration_${selectedSub.value}"]`) : null;
            const selectedDurationValue = selectedDurationSelect ? selectedDurationSelect.value : '';

            if (!startDate || !selectedSub || !selectedDurationValue) {
                subscriptionDatesSummary.classList.add('hidden');
                return;
            }
            
            const durationInDays = parseInt(selectedDurationValue.split('_')[0]);
            const deliveryDays = Array.from(deliveryDaysCheckboxes)
                .filter(cb => cb.checked) // Only count checked days as delivery days
                .map(cb => parseInt(cb.value));

            let currentDate = new Date(startDate);
            let subscriptionDaysCount = 0;
            
            while (subscriptionDaysCount < durationInDays) {
                const dayOfWeek = currentDate.getDay(); // 0 = الأحد, 1 = الاثنين...
                if (deliveryDays.includes(dayOfWeek)) {
                    subscriptionDaysCount++;
                }
                if (subscriptionDaysCount < durationInDays) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            const endDate = currentDate;
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            subscriptionDatesSummary.innerHTML = `
                يبدأ اشتراكك: <span class="font-bold">${new Date(startDate).toLocaleDateString('ar-KW', options)}</span><br>
                ينتهي اشتراكك: <span class="font-bold">${endDate.toLocaleDateString('ar-KW', options)}</span>
            `;
            subscriptionDatesSummary.classList.remove('hidden');
        }

        startDateInput.addEventListener('change', calculateEndDate);
        deliveryDaysCheckboxes.forEach(cb => cb.addEventListener('change', calculateEndDate));
        subscriptionRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const subscriptionId = radio.value;
                const isCustom = subscriptionsData[subscriptionId].isCustom;

                // Toggle visibility of duration selects
                document.querySelectorAll('select[name^="duration_"]').forEach(select => select.style.display = 'none');
                const selectedDurationSelect = document.querySelector(`select[name="duration_${subscriptionId}"]`);
                if (selectedDurationSelect) {
                    selectedDurationSelect.style.display = 'block';
                    selectedDurationSelect.addEventListener('change', calculateEndDate);
                }

                // Toggle visibility and required status of custom fields
                customSubscriptionPriceDiv.classList.toggle('hidden', !isCustom);
                customMealPlanImageUploadDiv.classList.toggle('hidden', !isCustom);
                
                if (isCustom) {
                    customSubscriptionPriceInput.setAttribute('required', '');
                    customMealPlanImageUploadInput.setAttribute('required', '');
                } else {
                    customSubscriptionPriceInput.removeAttribute('required');
                    customMealPlanImageUploadInput.removeAttribute('required');
                }

                calculateEndDate();
            });
        });

        // Handle form submission for creating/editing forms
        createFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Form submission initiated.");

            if (!currentUserId) {
                alert("الرجاء تسجيل الدخول كموظف.");
                console.error("Error: currentUserId is null. Cannot submit form.");
                return;
            }
            console.log("User authenticated. currentUserId:", currentUserId);

            const customerName = document.getElementById('name').value;
            const customerPhone = document.getElementById('phone').value;
            const addressType = document.querySelector('input[name="addressType"]:checked').value;
            const deliveryCost = parseFloat(document.getElementById('deliveryCost').value || '0');
            const selectedSubscriptionRadio = document.querySelector('input[name="subscription"]:checked');
            
            if (!selectedSubscriptionRadio) {
                alert("الرجاء اختيار نوع الاشتراك.");
                return;
            }
            const subscriptionId = selectedSubscriptionRadio.value;
            const subscriptionInfo = subscriptionsData[subscriptionId];
            
            let price;
            let durationInDays;
            let durationName;
            let customMealPlanImage = null;

            if (subscriptionInfo.isCustom) {
                price = parseFloat(customSubscriptionPriceInput.value);
                if (isNaN(price)) {
                    alert("الرجاء إدخال سعر صالح للاشتراك المخصص.");
                    return;
                }
                const selectedDurationSelect = document.querySelector(`select[name="duration_${subscriptionId}"]`);
                const selectedDurationValue = selectedDurationSelect ? selectedDurationSelect.value : '';
                if (!selectedDurationValue) {
                    alert("الرجاء اختيار فترة الاشتراك للاشتراك المخصص.");
                    return;
                }
                durationInDays = parseInt(selectedDurationValue.split('_')[0]);
                durationName = subscriptionInfo.durations[durationInDays];

                if (customMealPlanImageUploadInput.files.length > 0) {
                    const file = customMealPlanImageUploadInput.files[0];
                    if (file) {
                        const reader = new FileReader();
                        // Use a Promise to wait for FileReader to complete
                        customMealPlanImage = await new Promise((resolve, reject) => {
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = (e) => reject(e);
                            reader.readAsDataURL(file);
                        });
                    }
                } else if (currentFormId) {
                    // If editing and no new file selected, retain existing image if any
                    const existingFormSnap = await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/subscriptionForms`, currentFormId));
                    if (existingFormSnap.exists()) {
                        customMealPlanImage = existingFormSnap.data().subscription.customMealPlanImage || null;
                    }
                }

                if (!customMealPlanImage) {
                    alert("الرجاء تحميل أو التقاط صورة لجدول الوجبات المخصص.");
                    return;
                }

            } else {
                const durationSelect = document.querySelector(`select[name="duration_${subscriptionId}"]`);
                const selectedDurationValue = durationSelect.value;
                
                if (!selectedDurationValue) {
                    alert("الرجاء اختيار فترة الاشتراك.");
                    return;
                }

                durationInDays = parseInt(selectedDurationValue.split('_')[0]);
                price = parseFloat(selectedDurationValue.split('_')[1]);
                durationName = subscriptionInfo.durations[durationInDays];
            }

            const startDate = document.getElementById('startDate').value;
            if (!startDate) {
                alert("الرجاء تحديد يوم بدء الاشتراك.");
                return;
            }
            const deliveryTimeRadio = document.querySelector('input[name="deliveryTime"]:checked');
            if (!deliveryTimeRadio) {
                alert("الرجاء تحديد وقت التوصيل المناسب.");
                return;
            }
            const deliveryTime = deliveryTimeRadio.value;

            const selectedDeliveryDaysIndices = Array.from(deliveryDaysCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));

            const daysOfWeekNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            const daysOffNames = daysOfWeekNames.filter((_, index) => !selectedDeliveryDaysIndices.includes(index));
            
            // Calculate end date (same logic as before)
            let endDate = new Date(startDate);
            let totalDaysCount = 0;
            let currentCheckDate = new Date(startDate);

            while (totalDaysCount < durationInDays) {
                const dayOfWeek = currentCheckDate.getDay();
                if (selectedDeliveryDaysIndices.includes(dayOfWeek)) { // Only count if it's a delivery day
                    totalDaysCount++;
                }
                
                if (totalDaysCount < durationInDays) {
                     currentCheckDate.setDate(currentCheckDate.getDate() + 1);
                }
            }
            endDate = currentCheckDate;
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const endDateString = endDate.toLocaleDateString('ar-KW', options);

            let addressData = {};
            if (addressType === 'house') {
                addressData = {
                    type: 'house',
                    area: document.getElementById('houseArea').value,
                    block: document.getElementById('houseBlock').value,
                    street: document.getElementById('houseStreet').value,
                    ave: document.getElementById('houseAve').value || null,
                    number: document.getElementById('houseNumber').value,
                    neighbor: document.getElementById('houseNeighbor').value || null,
                };
            } else { // apartment
                addressData = {
                    type: 'apartment',
                    area: document.getElementById('apartmentArea').value,
                    block: document.getElementById('apartmentBlock').value,
                    street: document.getElementById('apartmentStreet').value,
                    ave: document.getElementById('apartmentAve').value || null,
                    building: document.getElementById('buildingNumber').value,
                    floor: document.getElementById('floorNumber').value,
                    apartment: document.getElementById('apartmentNumber').value,
                    neighbor: document.getElementById('apartmentNeighbor').value || null,
                };
            }

            // Fix: Use uuid.v4() instead of uuidv4()
            const formIdToUse = currentFormId || uuid.v4(); 
            const formNumber = currentFormId ? (await getDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/subscriptionForms`, currentFormId))).data().formNumber : Math.floor(100000 + Math.random() * 900000); // Simple random number for display

            const formData = {
                id: formIdToUse,
                formNumber: formNumber,
                employeeId: currentUserId,
                customerName,
                customerPhone,
                address: addressData,
                subscription: {
                    id: subscriptionId,
                    name: subscriptionInfo.name,
                    durationInDays,
                    durationName,
                    price,
                    customMealPlanImage: customMealPlanImage // Only present for custom subscriptions
                },
                startDate: new Date(startDate).toLocaleDateString('ar-KW', options),
                endDate: endDateString,
                daysOff: daysOffNames, // Store names of days off
                deliveryTime,
                deliveryCost,
                status: 'pending_signature',
                timestamp: new Date() // Use client-side timestamp for now, Firestore serverTimestamp is for server writes
            };

            console.log("Collected form data for submission:", formData);

            try {
                console.log("Attempting to save form to employee's private collection...");
                await setDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/subscriptionForms`, formIdToUse), formData);
                console.log("Form saved to employee's private collection successfully.");

                console.log("Attempting to save form to public collection for customer signature...");
                const publicFormData = {
                    formId: formIdToUse,
                    customerName,
                    customerPhone,
                    address: addressData,
                    subscription: {
                        id: subscriptionId,
                        name: subscriptionInfo.name,
                        durationInDays,
                        durationName,
                        price,
                        customMealPlanImage: customMealPlanImage // Only present for custom subscriptions
                    },
                    startDate: new Date(startDate).toLocaleDateString('ar-KW', options),
                    endDate: endDateString,
                    daysOff: daysOffNames,
                    deliveryTime,
                    deliveryCost,
                    totalPrice: price + deliveryCost,
                    termsAccepted: false,
                    signatureImage: null,
                    status: 'pending_signature',
                    timestamp: new Date(),
                    employeeId: currentUserId // Store employeeId in public form for later retrieval
                };
                // Fix: Changed path to include 'data' collection
                await setDoc(doc(db, `artifacts/${appId}/public/data/signedForms`, formIdToUse), publicFormData);
                console.log("Form saved to public collection successfully.");


                alert("تم حفظ الاستمارة بنجاح! سيتم الآن فتح واتساب لإرسال الرابط للعميل.");

                // Construct WhatsApp message
                const whatsappLink = `${window.location.origin}${window.location.pathname}#customer-signature?formId=${formIdToUse}`;
                const telegramMessage = subscriptionInfo.telegram ? `\nاشتراك تيليجرام مجاني: نعم` : '';

                const message = `
تم تعبئة بيانات استمارة الاشتراك الخاصة بك بنجاح،
يرجى الضغط على الرابط التالي للاعتماد والتوقيع:
${whatsappLink}
                `.trim();

                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${customerPhone}?text=${encodedMessage}`; // Use customer's phone number
                
                window.open(whatsappUrl, '_blank');
                console.log("WhatsApp URL opened:", whatsappUrl);

                window.location.hash = ''; // Go back to dashboard
                currentFormId = null; // Reset for next creation
            } catch (error) {
                console.error("Error saving form:", error);
                alert("حدث خطأ أثناء حفظ الاستمارة: " + error.message);
            }
        });

        // --- Customer Signature View Functions ---
        const customerSignatureView = document.getElementById('customerSignatureView');
        const customerFormDetails = document.getElementById('customerFormDetails');
        // Removed direct reference to signatureCanvas, clearSignatureBtn, approveSignatureBtn, signatureTermsCheck, signatureErrorMessage
        // These will be re-initialized after innerHTML is set to ensure they exist in the DOM

        let signaturePad = null;

        async function showCustomerSignaturePage() {
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            customerSignatureView.classList.remove('hidden');
            customerFormDetails.innerHTML = '<p class="text-center text-gray-500">جاري تحميل بيانات الاشتراك...</p>';
            
            // Reset state for signature page elements
            // These elements are recreated dynamically, so we need to ensure they are accessed *after* innerHTML is set
            // For now, we'll assume they will be accessed via document.getElementById within the function after they are rendered.

            if (!currentFormId) {
                customerFormDetails.innerHTML = '<p class="text-center text-red-500">رابط الاشتراك غير صالح أو مفقود.</p>';
                return;
            }

            try {
                // Fix: Changed path to include 'data' collection
                const formRef = doc(db, `artifacts/${appId}/public/data/signedForms`, currentFormId);
                const unsubscribe = onSnapshot(formRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const subscriptionInfo = subscriptionsData[data.subscription.id];
                        const isFormSigned = data.status === 'signed';

                        const totalPrice = data.subscription.price + data.deliveryCost;
                        const deliveryCostText = data.deliveryCost > 0 ? `${data.deliveryCost} د.ك` : 'مجاني';
                        const telegramMessage = subscriptionInfo.telegram ? `اشتراك تيليجرام مجاني: نعم` : 'لا يوجد اشتراك تيليجرام مجاني';

                        customerFormDetails.innerHTML = `
                            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">تفاصيل استمارة الاشتراك</h2>
                            <div class="bg-white p-6 rounded-lg shadow-md space-y-3">
                                <p><strong>الاسم:</strong> ${data.customerName}</p>
                                <p><strong>رقم الهاتف:</strong> ${data.customerPhone}</p>
                                <p><strong>المنطقة:</strong> ${data.address.area}</p>
                                <p><strong>الشارع:</strong> ${data.address.street}</p>
                                ${data.address.type === 'house' ? `<p><strong>رقم المنزل:</strong> ${data.address.number}</p>` : ''}
                                ${data.address.type === 'apartment' ? `
                                    <p><strong>رقم/اسم البناية:</strong> ${data.address.building}</p>
                                    <p><strong>الطابق:</strong> ${data.address.floor}</p>
                                    <p><strong>الشقة:</strong> ${data.address.apartment}</p>
                                ` : ''}
                                ${data.address.ave ? `<p><strong>الجادة:</strong> ${data.address.ave}</p>` : ''}
                                ${data.address.neighbor ? `<p><strong>مبنى مجاور:</strong> ${data.address.neighbor}</p>` : ''}
                                <p><strong>نوع الاشتراك:</strong> ${data.subscription.name}</p>
                                <p><strong>المدة:</strong> ${data.subscription.durationName} (${data.subscription.durationInDays} يوم)</p>
                                <p><strong>تاريخ البدء:</strong> ${data.startDate}</p>
                                <p><strong>تاريخ الانتهاء:</strong> ${data.endDate}</p>
                                <p><strong>أيام عدم التوصيل:</strong> ${data.daysOff.length > 0 ? data.daysOff.join(', ') : 'لا يوجد'}</p>
                                <p><strong>وقت التوصيل:</strong> ${data.deliveryTime}</p>
                                <p><strong>سعر الاشتراك:</strong> ${data.subscription.price} د.ك</p>
                                <p><strong>سعر التوصيل:</strong> ${deliveryCostText}</p>
                                <p class="text-lg font-bold text-green-700"><strong>الإجمالي:</strong> ${totalPrice} د.ك</p>
                                <p>${telegramMessage}</p>
                                <div class="mt-4 text-center">
                                    <button type="button" id="browseMealPlanBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">تصفح وجبات الاشتراك</button>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg mt-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">الشروط والأحكام</h2>
                                <div class="text-sm text-gray-600 space-y-2">
                                    <p>قد يكون هناك رسوم توصيل إضافية على سعر الاشتراك.</p>
                                    <p>إذا تم إلغاء الاشتراك لأي سبب من طرف العميل، يتم حساب المبلغ المتبقي من الاشتراك ويصبح كوبون مشتريات للعميل يمكنه الشراء به من مخبز التين والزيتون أو مطعم التين الطبيعي في أي وقت.</p>
                                </div>
                                <div class="mt-4 flex items-start">
                                    <input type="checkbox" id="signatureTermsCheck" name="signatureTermsCheck" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500" ${isFormSigned ? 'disabled' : ''}>
                                    <label for="signatureTermsCheck" class="mr-2 text-sm font-medium text-gray-700 cursor-pointer">أوافق على الشروط والأحكام.</label>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg mt-6">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">يرجى التوقيع داخل المربع لاعتماد الاشتراك.</h2>
                                <canvas id="signatureCanvas" class="border border-gray-300 rounded-md w-full h-48 bg-white"></canvas>
                                <div class="flex justify-center mt-4 space-x-4">
                                    <button type="button" id="clearSignatureBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors" ${isFormSigned ? 'disabled' : ''}>مسح التوقيع</button>
                                </div>
                            </div>
                            <div class="mt-8 text-center">
                                <button type="button" id="approveSignatureBtn" class="w-full px-6 py-3 text-lg font-bold text-white ${isFormSigned ? 'bg-green-600' : 'bg-gray-400'} rounded-xl shadow-lg transition-colors duration-300 ${isFormSigned ? '' : 'cursor-not-allowed'}" ${isFormSigned ? 'disabled' : 'disabled'}>
                                    ${isFormSigned ? 'تم الاعتماد' : 'اعتمد'}
                                </button>
                                <div id="signatureErrorMessage" class="text-red-500 text-sm mt-2 text-center hidden">
                                    الرجاء التوقيع والموافقة على الشروط والأحكام.
                                </div>
                            </div>
                        `;

                        // Re-initialize signature pad after content is loaded
                        const canvas = document.getElementById('signatureCanvas');
                        const approveSignatureBtn = document.getElementById('approveSignatureBtn');
                        const clearSignatureBtn = document.getElementById('clearSignatureBtn');
                        const signatureTermsCheck = document.getElementById('signatureTermsCheck');
                        const signatureErrorMessage = document.getElementById('signatureErrorMessage'); // Re-get this element
                        const browseMealPlanBtn = document.getElementById('browseMealPlanBtn');

                        if (canvas && !isFormSigned) { // Only initialize if not signed
                            signaturePad = new SignaturePad(canvas);
                            // Adjust canvas size for responsiveness
                            function resizeCanvas() {
                                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                                canvas.width = canvas.offsetWidth * ratio;
                                canvas.height = canvas.offsetHeight * ratio;
                                canvas.getContext("2d").scale(ratio, ratio);
                                signaturePad.clear(); // clear canvas for redraw
                            }
                            window.addEventListener('resize', resizeCanvas);
                            resizeCanvas(); // Initial resize

                            // Event listeners for signature pad
                            signaturePad.onEnd = () => checkSignatureAndTerms(approveSignatureBtn, signatureTermsCheck, signatureErrorMessage);
                            clearSignatureBtn.onclick = () => {
                                signaturePad.clear();
                                checkSignatureAndTerms(approveSignatureBtn, signatureTermsCheck, signatureErrorMessage);
                            };
                            signatureTermsCheck.onchange = () => checkSignatureAndTerms(approveSignatureBtn, signatureTermsCheck, signatureErrorMessage);
                            // Fix: Changed 'clearBtn' to 'clearSignatureBtn'
                            approveSignatureBtn.onclick = () => submitSignature(approveSignatureBtn, clearSignatureBtn, signatureTermsCheck, signatureErrorMessage); 
                            
                            // Initial check for button state
                            checkSignatureAndTerms(approveSignatureBtn, signatureTermsCheck, signatureErrorMessage);
                        } else if (isFormSigned) {
                            // If already signed, display the signature image
                            if (data.signatureImage) {
                                const ctx = canvas.getContext('2d');
                                const img = new Image();
                                img.onload = () => {
                                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                                    canvas.width = canvas.offsetWidth * ratio;
                                    canvas.height = canvas.offsetHeight * ratio;
                                    ctx.scale(ratio, ratio);
                                    ctx.drawImage(img, 0, 0, canvas.width / ratio, canvas.height / ratio);
                                };
                                img.src = data.signatureImage;
                            }
                            if (signaturePad) signaturePad.off(); // Disable signature pad if signed
                        }

                        // Event listener for browse meal plan button
                        if (browseMealPlanBtn) {
                            browseMealPlanBtn.onclick = () => {
                                if (data.subscription.id === 'custom' && data.subscription.customMealPlanImage) {
                                    showMealPlan(data.subscription.customMealPlanImage, true); // Pass true for base64 image
                                } else {
                                    showMealPlan(`a${data.subscription.id}.jpg`);
                                }
                            };
                        }

                    } else {
                        customerFormDetails.innerHTML = '<p class="text-center text-red-500">رابط الاشتراك هذا غير موجود أو تم حذفه.</p>';
                    }
                });
            } catch (error) {
                console.error("Error fetching customer form:", error);
                customerFormDetails.innerHTML = '<p class="text-center text-red-500">حدث خطأ أثناء تحميل بيانات الاشتراك.</p>';
            }
        }

        // Pass elements as arguments to ensure they are the correct, dynamically created ones
        function checkSignatureAndTerms(approveBtn, termsCheck, errorMsg) {
            const isSigned = signaturePad && !signaturePad.isEmpty();
            const termsAccepted = termsCheck.checked;
            approveBtn.disabled = !(isSigned && termsAccepted);
            if (isSigned && termsAccepted) {
                approveBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                approveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                errorMsg.classList.add('hidden');
            } else {
                approveBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                approveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        }

        async function submitSignature(approveBtn, clearBtn, termsCheck, errorMsg) {
            if (signaturePad.isEmpty()) {
                errorMsg.textContent = "الرجاء التوقيع داخل المربع.";
                errorMsg.classList.remove('hidden');
                return;
            }
            if (!termsCheck.checked) {
                errorMsg.textContent = "الرجاء الموافقة على الشروط والأحكام.";
                errorMsg.classList.remove('hidden');
                return;
            }

            const signatureImage = signaturePad.toDataURL(); // Get signature as base64 image

            try {
                // Update the public form with signature and status
                // Fix: Changed path to include 'data' collection
                await updateDoc(doc(db, `artifacts/${appId}/public/data/signedForms`, currentFormId), {
                    signatureImage: signatureImage,
                    termsAccepted: true,
                    status: 'signed',
                    signedTimestamp: new Date()
                });

                // Update the employee's private form status
                // A better approach: store employeeId in the public form document when it's created
                // Fix: Changed path to include 'data' collection
                const publicFormDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/signedForms`, currentFormId));
                if (publicFormDoc.exists() && publicFormDoc.data().employeeId) {
                    const employeeIdOfForm = publicFormDoc.data().employeeId;
                    await updateDoc(doc(db, `artifacts/${appId}/users/${employeeIdOfForm}/subscriptionForms`, currentFormId), {
                        status: 'signed'
                    });
                } else {
                    console.warn("Could not find employeeId in public form or employee form to update status.");
                }

                showSuccessModal(); // Show success pop-up
                approveBtn.disabled = true;
                clearBtn.disabled = true;
                termsCheck.disabled = true;
                signaturePad.off(); // Disable further drawing
            } catch (error) {
                console.error("Error submitting signature:", error);
                errorMsg.textContent = "حدث خطأ أثناء اعتماد التوقيع. الرجاء المحاولة مرة أخرى.";
                errorMsg.classList.remove('hidden');
            }
        }

        function showSuccessModal() {
            const successModal = document.getElementById('successModal');
            successModal.classList.remove('hidden');
            successModal.classList.add('flex');
        }

        // Event listener for success modal close button
        document.getElementById('successModalCloseBtn').addEventListener('click', () => {
            const successModal = document.getElementById('successModal');
            successModal.classList.add('hidden');
            successModal.classList.remove('flex');
            window.location.hash = ''; // Go back to dashboard after closing modal
        });

        // --- General UI Functions ---
        function showMealPlan(imageSource, isBase64 = false) {
            console.log("showMealPlan called with:", imageSource, "isBase64:", isBase64);
            const mealPlanModal = document.getElementById('mealPlanModal');
            const modalImage = document.getElementById('modalImage');
            
            if (isBase64) {
                modalImage.src = imageSource;
                modalImage.onerror = null; // No fallback needed for base64
                console.log("Displaying base64 image.");
            } else {
                modalImage.src = imageSource;
                modalImage.onerror = function() {
                    console.warn("Image failed to load:", imageSource, "Using placeholder.");
                    // Extract subscription number from the image source (e.g., "a1.jpg" -> "1")
                    const subscriptionNumberMatch = imageSource.match(/a(\d+)\.jpg/);
                    const subscriptionNumber = subscriptionNumberMatch ? subscriptionNumberMatch[1] : null;
                    const text = subscriptionNumber ? `جدول وجبات رقم ${subscriptionNumber}` : 'جدول وجبات غير متوفر';
                    modalImage.src = `https://placehold.co/800x600/526743/ffffff?text=${encodeURIComponent(text)}`;
                    modalImage.onerror = null; // Prevent infinite loop
                };
                console.log("Displaying external image (or placeholder if failed).");
            }
            mealPlanModal.style.display = "flex";
            console.log("Meal plan modal displayed.");
        }

        function closeMealPlanModal() {
            document.getElementById('mealPlanModal').style.display = "none";
        }

        // Initial render when the script loads
        signInUser(); // Start the authentication process
    </script>

    <style>
        /* Base styles for all views */
        .view-container {
            width: 100%;
            max-width: 2xl;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
        }
        /* Specific styles for dashboard cards */
        #formsList > div {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        /* Style for the date picker */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Dashboard View -->
    <div id="dashboardView" class="view-container hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">استمارات الاشتراكات</h1>
            <div class="mb-6 text-center">
                <button id="createFormButton" class="bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-green-700 transition-colors duration-300">
                    إنشاء استمارة اشتراك جديدة
                </button>
            </div>
            <div id="formsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Forms will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Create/Edit Form View -->
    <div id="createFormView" class="view-container hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">إنشاء / تعديل استمارة اشتراك</h1>
            
            <form id="createFormElement" class="space-y-6">
                <!-- قسم المعلومات الشخصية -->
                <div class="bg-gray-50 p-6 rounded-lg text-right">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">بيانات العميل</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">الاسم الكامل</label>
                            <input type="text" id="name" name="name" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
                            <input type="tel" id="phone" name="phone" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-left" placeholder="965XXXXXXXX" required>
                            <small class="mt-1 text-xs text-gray-500">سيتم تحويل الأرقام العربية إلى إنجليزية تلقائياً.</small>
                        </div>
                    </div>
                </div>

                <!-- قسم العنوان -->
                <div class="bg-gray-50 p-6 rounded-lg text-right">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">معلومات العنوان</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <label class="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="radio" name="addressType" value="house" checked class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                            <span class="ml-2">بيت</span>
                        </label>
                        <label class="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="radio" name="addressType" value="apartment" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                            <span class="ml-2">شقة</span>
                        </label>
                    </div>

                    <!-- حقول عنوان البيت -->
                    <div id="houseFields" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="houseArea" class="block text-sm font-medium text-gray-700">المنطقة</label>
                                <input type="text" id="houseArea" name="houseArea" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label for="houseBlock" class="block text-sm font-medium text-gray-700">القطعة</label>
                                <input type="text" id="houseBlock" name="houseBlock" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label for="houseStreet" class="block text-sm font-medium text-gray-700">الشارع</label>
                                <input type="text" id="houseStreet" name="houseStreet" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label for="houseAve" class="block text-sm font-medium text-gray-700">الجادة (اختياري)</label>
                                <input type="text" id="houseAve" name="houseAve" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="houseNumber" class="block text-sm font-medium text-gray-700">رقم المنزل</label>
                                <input type="text" id="houseNumber" name="houseNumber" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                        </div>
                        <div>
                            <label for="houseNeighbor" class="block text-sm font-medium text-gray-700">مبنى مجاور؟ (اختياري)</label>
                            <input type="text" id="houseNeighbor" name="houseNeighbor" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>

                    <!-- حقول عنوان الشقة (مخفية بشكل افتراضي) -->
                    <div id="apartmentFields" class="space-y-4 hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="apartmentArea" class="block text-sm font-medium text-gray-700">المنطقة</label>
                                <input type="text" id="apartmentArea" name="apartmentArea" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="apartmentBlock" class="block text-sm font-medium text-gray-700">القطعة</label>
                                <input type="text" id="apartmentBlock" name="apartmentBlock" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="apartmentStreet" class="block text-sm font-medium text-gray-700">الشارع</label>
                                <input type="text" id="apartmentStreet" name="apartmentStreet" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="apartmentAve" class="block text-sm font-medium text-gray-700">الجادة (اختياري)</label>
                                <input type="text" id="apartmentAve" name="apartmentAve" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="buildingNumber" class="block text-sm font-medium text-gray-700">رقم/اسم البناية</label>
                                <input type="text" id="buildingNumber" name="buildingNumber" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="floorNumber" class="block text-sm font-medium text-gray-700">الطابق</label>
                                <input type="text" id="floorNumber" name="floorNumber" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="apartmentNumber" class="block text-sm font-medium text-gray-700">الشقة</label>
                                <input type="text" id="apartmentNumber" name="apartmentNumber" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                        <div>
                            <label for="apartmentNeighbor" class="block text-sm font-medium text-gray-700">مبنى مجاور؟ (اختياري)</label>
                            <input type="text" id="apartmentNeighbor" name="apartmentNeighbor" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                </div>

                <!-- قسم الاشتراكات -->
                <div class="bg-gray-50 p-6 rounded-lg text-right">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">اختر نوع الاشتراك <span class="text-sm font-normal text-gray-500">(اضغط على زر جدول الوجبات لعرض جدول الوجبات لكل اشتراك)</span></h2>
                    <div class="space-y-4">
                        <!-- الاشتراكات -->
                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="1" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500" required>
                                <span class="mr-2">1. اشتراك إنقاص الوزن النباتي</span>
                            </label>
                            <select name="duration_1" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_87.5">أسبوع (87.5 د.ك)</option>
                                <option value="14_120">2 أسبوع (120 د.ك)</option>
                                <option value="28_240">4 أسابيع (240 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a1.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>
                        
                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="2" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">2. اشتراك إنقاص الوزن</span>
                            </label>
                            <select name="duration_2" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_93.5">أسبوع (93.5 د.ك)</option>
                                <option value="14_130">2 أسبوع (130 د.ك)</option>
                                <option value="28_250">4 أسابيع (250 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a2.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>
                        
                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="3" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">3. اشتراك خاص لرفع المناعة</span>
                            </label>
                            <select name="duration_3" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_95">أسبوع (95 د.ك)</option>
                                <option value="14_145">2 أسبوع (145 د.ك)</option>
                                <option value="28_280">4 أسابيع (280 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a3.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="4" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">4. اشتراك نظام الكيتو</span>
                            </label>
                            <select name="duration_4" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_95">أسبوع (95 د.ك)</option>
                                <option value="14_140">2 أسبوع (140 د.ك)</option>
                                <option value="28_280">4 أسابيع (280 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a4.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="5" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">5. اشتراك خالي من الجلوتين</span>
                            </label>
                            <select name="duration_5" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_93.5">أسبوع (93.5 د.ك)</option>
                                <option value="14_130">2 أسبوع (130 د.ك)</option>
                                <option value="28_260">4 أسابيع (260 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a5.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="6" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">6. اشتراك خالي من الجلوتين ومنتجات الألبان</span>
                            </label>
                            <select name="duration_6" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_91.5">أسبوع (91.5 د.ك)</option>
                                <option value="14_128.5">2 أسبوع (128.5 د.ك)</option>
                                <option value="28_255">4 أسابيع (255 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a6.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="7" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">7. اشتراك التخلص من الالتهابات بالصيام المتقطع (مع اشتراك تيليجرام مجاني)</span>
                            </label>
                            <select name="duration_7" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="10_120">10 أيام (120 د.ك)</option>
                                <option value="20_200">20 يوم (200 د.ك)</option>
                                <option value="30_290">30 يوم (290 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a7.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="8" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">8. اشتراك التخلص من الإلتهابات بدون صيام (مع اشتراك تيليجرام مجاني)</span>
                            </label>
                            <select name="duration_8" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="10_130">10 أيام (130 د.ك)</option>
                                <option value="20_210">20 يوم (210 د.ك)</option>
                                <option value="30_300">30 يوم (300 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a8.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>
                        
                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="9" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">9. اشتراك رمضان</span>
                            </label>
                            <select name="duration_9" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_90">أسبوع (90 د.ك)</option>
                                <option value="14_140">2 أسبوع (140 د.ك)</option>
                                <option value="28_240">4 أسابيع (240 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a9.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>
                        
                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="10" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">10. اشتراك رمضان النباتي</span>
                            </label>
                            <select name="duration_10" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_80">أسبوع (80 د.ك)</option>
                                <option value="14_130">2 أسبوع (130 د.ك)</option>
                                <option value="28_230">4 أسابيع (230 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a10.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>
                        
                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="11" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">11. اشتراك رفع نسب امتصاص الفيتامينات، والمعادن (يصلح للنساء الحوامل)</span>
                            </label>
                            <select name="duration_11" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_93.5">أسبوع (93.5 د.ك)</option>
                                <option value="14_130">2 أسبوع (130 د.ك)</option>
                                <option value="28_250">4 أسابيع (250 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a11.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="12" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">12. اشتراك خاص للنساء المرضعات</span>
                            </label>
                            <select name="duration_12" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_93.5">أسبوع (93.5 د.ك)</option>
                                <option value="14_130">2 أسبوع (130 د.ك)</option>
                                <option value="28_260">4 أسابيع (260 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a12.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="13" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">13. اشتراك ضد أنواع الحساسيات الشائعة</span>
                            </label>
                            <select name="duration_13" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_96.5">أسبوع (96.5 د.ك)</option>
                                <option value="14_133.5">2 أسبوع (133.5 د.ك)</option>
                                <option value="28_260">4 أسابيع (260 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a13.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="14" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">14. اشتراك خاص للرياضيين</span>
                            </label>
                            <select name="duration_14" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="10_120">10 أيام (120 د.ك)</option>
                                <option value="20_180">20 يوم (180 د.ك)</option>
                                <option value="30_230">30 يوم (230 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a14.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="15" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">15. اسلوب الحياة الصحية (غير مخصص لخسارة الوزن)</span>
                            </label>
                            <select name="duration_15" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="10_120">10 أيام (120 د.ك)</option>
                                <option value="20_180">20 يوم (180 د.ك)</option>
                                <option value="30_230">30 يوم (230 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a15.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="16" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">16. اشتراك الأخصائية ريم العنزي، محسوب السعرات</span>
                            </label>
                            <select name="duration_16" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="10_150">10 أيام (150 د.ك)</option>
                                <option value="20_200">20 يوم (200 د.ك)</option>
                                <option value="30_230">30 يوم (230 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a16.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="17" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">17. اشتراك ريوق المستشفى</span>
                            </label>
                            <select name="duration_17" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_50">أسبوع (50 د.ك)</option>
                                <option value="14_80">2 أسبوع (80 د.ك)</option>
                                <option value="28_120">4 أسابيع (120 د.ك)</option>
                            </select>
                            <button type="button" onclick="showMealPlan('a17.jpg')" class="bg-green-500 text-white text-xs px-2 py-1 rounded-md hover:bg-green-600 transition-colors">جدول الوجبات</button>
                        </div>

                        <!-- Custom Subscription Option -->
                        <div class="flex items-center gap-4 bg-white p-4 rounded-md shadow-sm">
                            <label class="flex-1 flex-row-reverse flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="radio" name="subscription" value="custom" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500">
                                <span class="mr-2">18. اشتراك مخصص</span>
                            </label>
                            <select name="duration_custom" class="w-1/2 sm:w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm" style="display: none;">
                                <option value="" disabled selected>اختر الفترة</option>
                                <option value="7_0">أسبوع</option>
                                <option value="14_0">2 أسبوع</option>
                                <option value="28_0">4 أسابيع</option>
                                <option value="30_0">30 يوم</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Custom Subscription Price and Image Upload -->
                    <div id="customSubscriptionPriceDiv" class="mt-4 space-y-4 hidden">
                        <div>
                            <label for="customSubscriptionPrice" class="block text-sm font-medium text-gray-700">سعر الاشتراك المخصص (د.ك)</label>
                            <input type="number" id="customSubscriptionPrice" name="customSubscriptionPrice" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-left" min="0" step="0.1">
                        </div>
                    </div>
                    <div id="customMealPlanImageUploadDiv" class="mt-4 space-y-4 hidden">
                        <div>
                            <label for="customMealPlanImageUpload" class="block text-sm font-medium text-gray-700">تحميل / التقاط صورة لجدول الوجبات المخصص</label>
                            <input type="file" id="customMealPlanImageUpload" name="customMealPlanImageUpload" accept="image/*" capture="camera" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                            <img id="customMealPlanImagePreview" src="" alt="معاينة جدول الوجبات المخصص" class="mt-4 max-w-full h-auto rounded-md shadow-md hidden">
                        </div>
                    </div>
                </div>

                <!-- قسم التواريخ والأيام -->
                <div class="bg-gray-50 p-6 rounded-lg text-right">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">تحديد أيام الاشتراك</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700">يوم بدء الاشتراك</label>
                            <input type="date" id="startDate" name="startDate" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                        </div>
                        <div id="subscriptionDatesSummary" class="bg-gray-100 p-4 rounded-md text-center text-sm font-medium text-gray-600 hidden">
                            <!-- هنا سيتم عرض تاريخي البدء والانتهاء -->
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الأيام التي لا تريد فيها استلام وجبات:</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 text-sm text-center">
                                <!-- مربعات اختيار أيام الأسبوع -->
                                <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-center cursor-pointer">
                                    <input type="checkbox" name="deliveryDays" value="0" checked class="h-4 w-4 text-green-600 border-gray-300 rounded">
                                    <span class="mr-2">الأحد</span>
                                </label>
                                <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-center cursor-pointer">
                                    <input type="checkbox" name="deliveryDays" value="1" checked class="h-4 w-4 text-green-600 border-gray-300 rounded">
                                    <span class="mr-2">الاثنين</span>
                                </label>
                                <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-center cursor-pointer">
                                    <input type="checkbox" name="deliveryDays" value="2" checked class="h-4 w-4 text-green-600 border-gray-300 rounded">
                                    <span class="mr-2">الثلاثاء</span>
                                </label>
                                <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-center cursor-pointer">
                                    <input type="checkbox" name="deliveryDays" value="3" checked class="h-4 w-4 text-green-600 border-gray-300 rounded">
                                    <span class="mr-2">الأربعاء</span>
                                </label>
                                <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-center cursor-pointer">
                                    <input type="checkbox" name="deliveryDays" value="4" checked class="h-4 w-4 text-green-600 border-gray-300 rounded">
                                    <span class="mr-2">الخميس</span>
                                </label>
                                <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-center cursor-pointer">
                                    <input type="checkbox" name="deliveryDays" value="5" checked class="h-4 w-4 text-green-600 border-gray-300 rounded">
                                    <span class="mr-2">الجمعة</span>
                                </label>
                                <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-center cursor-pointer">
                                    <input type="checkbox" name="deliveryDays" value="6" checked class="h-4 w-4 text-green-600 border-gray-300 rounded">
                                    <span class="mr-2">السبت</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- قسم وقت التوصيل المناسب -->
                <div class="bg-gray-50 p-6 rounded-lg text-right">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">وقت التوصيل المناسب</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-center">
                        <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-start cursor-pointer">
                            <input type="radio" name="deliveryTime" value="9 صباحًا إلى 12 ظهرًا" class="h-4 w-4 text-green-600 border-gray-300 rounded" required>
                            <span class="mr-2">9 صباحًا إلى 12 ظهرًا</span>
                        </label>
                        <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-start cursor-pointer">
                            <input type="radio" name="deliveryTime" value="12 ظهرًا إلى 3 مساءً" class="h-4 w-4 text-green-600 border-gray-300 rounded">
                            <span class="mr-2">12 ظهرًا إلى 3 مساءً</span>
                        </label>
                        <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-start cursor-pointer">
                            <input type="radio" name="deliveryTime" value="3 مساءً إلى 6 مساءً" class="h-4 w-4 text-green-600 border-gray-300 rounded">
                            <span class="mr-2">3 مساءً إلى 6 مساءً</span>
                        </label>
                        <label class="bg-white p-2 rounded-md shadow-sm flex items-center justify-start cursor-pointer">
                            <input type="radio" name="deliveryTime" value="6 مساءً إلى 9 مساءً" class="h-4 w-4 text-green-600 border-gray-300 rounded">
                            <span class="mr-2">6 مساءً إلى 9 مساءً</span>
                        </label>
                    </div>
                </div>

                <!-- قيمة التوصيل -->
                <div class="bg-gray-50 p-6 rounded-lg text-right">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">قيمة التوصيل</h2>
                    <div>
                        <label for="deliveryCost" class="block text-sm font-medium text-gray-700">قيمة التوصيل (د.ك)</label>
                        <input type="number" id="deliveryCost" name="deliveryCost" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 text-left" value="0" min="0" step="0.1" required>
                        <small class="mt-1 text-xs text-gray-500">ادخل 0 إذا كان التوصيل مجاني.</small>
                    </div>
                </div>

                <!-- زر الإرسال للتوقيع -->
                <div class="mt-8 text-center">
                    <button type="submit" id="createFormSubmitBtn" class="w-full px-6 py-3 text-lg font-bold text-white bg-green-600 rounded-xl shadow-lg hover:bg-green-700 transition-colors duration-300">
                        إرسال للتوقيع
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Signature View -->
    <div id="customerSignatureView" class="view-container hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">استمارة اشتراك</h1>
            <div id="customerFormDetails" class="space-y-6">
                <!-- Customer form details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- نافذة عرض صورة جدول الوجبات -->
    <div id="mealPlanModal" class="modal">
        <span class="modal-close" onclick="closeMealPlanModal()">&times;</span>
        <img class="modal-content rounded-lg" id="modalImage">
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h2 class="text-2xl font-bold text-green-700 mb-4">شكراً لثقتكم!</h2>
            <p class="text-gray-700 mb-6">تم اعتماد الاشتراك بنجاح، يرجى المتابعة مع الموظف للدفع.</p>
            <button id="successModalCloseBtn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">إغلاق</button>
        </div>
    </div>

</body>
</html>
